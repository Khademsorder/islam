<!DOCTYPE html>
<html lang="bn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>কুরআন ও হাদিস · অফলাইন হাব</title>

    <!-- Fonts & Icons -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0,1" />
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700;800&family=Amiri:wght@400;700&family=Scheherazade+New:wght@400;700&display=swap"
        rel="stylesheet">
    <!-- ResponsiveVoice for TTS -->
    <script src="https://code.responsivevoice.org/responsivevoice.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Load Islamic Module -->
    <script src="quran-module.js"></script>

    <!-- PWA & Native App Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0b5e42" id="meta-theme-color">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="logo.png">

    <style>
        /* Base Variables exactly like islamic.html */
        :root {
            --bg-main: #f4f7f6;
            --bg-surface: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
            --accent-primary: #0b5e42;
            --accent-hover: #084c35;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 8px 16px rgba(0, 0, 0, 0.1);
            --mag-3-bg: #e3f2fd;
            --mag-3-border: #64b5f6;
        }

        [data-theme="dark"] {
            --bg-main: #0f172a;
            --bg-surface: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --accent-primary: #10b981;
            --accent-hover: #059669;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
            --shadow-md: 0 8px 16px rgba(0, 0, 0, 0.5);
            --mag-3-bg: #78350f;
            --mag-3-border: #d97706;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans Bengali', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            transition: all 0.3s ease;
            line-height: 1.6;
        }

        .container {
            margin: 0 auto;
            padding: 0 16px;
            max-width: 900px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: var(--bg-surface);
            border-bottom: 2px solid var(--accent-primary);
            border-radius: 0 0 24px 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }

        .logo {
            font-size: 20px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--accent-primary);
            cursor: pointer;
        }

        .icon-btn {
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            border: none;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: var(--border-color);
            color: var(--accent-primary);
        }

        /* Search */
        .search-bar {
            display: flex;
            align-items: center;
            background: var(--bg-surface);
            border-radius: 50px;
            padding: 8px 20px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .search-bar:focus-within {
            border-color: var(--accent-primary);
        }

        .search-bar input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 16px;
            color: var(--text-primary);
            outline: none;
            padding: 10px 0;
            font-family: inherit;
        }

        /* Navigation Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .tab {
            padding: 10px 24px;
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
        }

        .tab.active {
            background: var(--accent-primary);
            color: #fff;
            border-color: var(--accent-primary);
            box-shadow: 0 4px 12px rgba(11, 94, 66, 0.3);
        }

        /* Grid & Cards */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            padding-bottom: 40px;
        }

        .surah-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: var(--shadow-sm);
        }

        .surah-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-md);
        }

        .surah-num {
            background: var(--bg-main);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: cursive;
        }

        .surah-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .surah-sub {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .surah-arabic {
            font-family: 'Amiri', serif;
            font-size: 20px;
            color: var(--accent-primary);
        }

        /* Dedicated Reading View */
        #readerView {
            display: none;
            padding-bottom: 60px;
        }

        .reader-header {
            text-align: center;
            margin-bottom: 32px;
            background: var(--bg-surface);
            padding: 24px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            position: relative;
        }

        .bismillah {
            font-family: 'Scheherazade New', serif;
            font-size: 32px;
            margin: 24px 0;
            color: var(--text-primary);
            text-align: center;
        }

        .ayah-card {
            background: var(--bg-surface);
            border-radius: 16px;
            margin-bottom: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--accent-primary);
            box-shadow: var(--shadow-sm);
            transition: 0.3s;
        }

        .ayah-card:hover {
            transform: translateX(4px);
        }

        .ayah-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 12px;
            margin-bottom: 16px;
        }

        .ayah-arabic {
            font-family: 'Scheherazade New', 'Amiri', serif;
            font-size: 34px;
            line-height: 2;
            text-align: right;
            direction: rtl;
            margin-bottom: 16px;
        }

        .ayah-bangla {
            font-size: 18px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .ayah-pronunciation {
            font-size: 16px;
            color: #6d28d9;
            line-height: 1.6;
            margin-top: 10px;
            padding-left: 10px;
            border-left: 3px solid #c4b5fd;
        }

        .ayah-english {
            font-size: 16px;
            color: #1d4ed8;
            line-height: 1.6;
            margin-top: 10px;
            padding-left: 10px;
            border-left: 3px solid #93c5fd;
        }

        .reader-toggle-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            justify-content: center;
        }

        .toggle-chip {
            border: 1px solid var(--border-color);
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 700;
            background: var(--bg-main);
            color: var(--text-primary);
            cursor: pointer;
        }

        .toggle-chip.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: #fff;
        }

        /* Action buttons inside text */
        .btn-action {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--text-primary);
            transition: 0.3s;
        }

        .btn-action:hover {
            background: var(--bg-main);
            border-color: var(--accent-primary);
        }

        /* Loader */
        .loader {
            display: none;
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .offline-badge {
            font-size: 12px;
            background: #ecfdf5;
            color: #047857;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
            border: 1px solid #10b981;
            display: none;
        }

        .is-offline .offline-badge {
            display: inline-block;
        }

        .is-offline .dl-btn {
            display: none;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: -80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: var(--bg-surface);
            padding: 14px 28px;
            border-radius: 50px;
            transition: bottom 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 2000;
            font-weight: bold;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.show {
            bottom: 32px;
        }

        /* ==================================================
           [5] NATIVE APP UI COMPONENTS (PWA)
           ================================================== */
        body {
            padding-bottom: 70px;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 65px;
            background: var(--bg-surface);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            z-index: 1000;
            border-top: 1px solid var(--border-color);
            padding-bottom: env(safe-area-inset-bottom, 0px);
            transition: background 0.3s;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.3s;
            flex: 1;
            padding: 8px 0;
        }

        .nav-item .material-symbols-rounded {
            font-size: 24px;
            margin-bottom: 4px;
            transition: transform 0.3s;
        }

        .nav-item.active {
            color: var(--accent-primary);
        }

        .nav-item.active .material-symbols-rounded {
            font-variation-settings: 'FILL' 1;
            transform: translateY(-2px);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            backdrop-filter: blur(2px);
        }

        .sidebar-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 280px;
            background: var(--bg-surface);
            z-index: 2000;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sb-header {
            padding: 24px;
            background: var(--accent-primary);
            color: #fff;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-bottom-right-radius: 20px;
            transition: background 0.3s;
        }

        .sb-content {
            padding: 16px;
            flex: 1;
            overflow-y: auto;
        }

        .sb-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 16px;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            transition: background 0.3s, color 0.3s;
            cursor: pointer;
        }

        .sb-item:hover,
        .sb-item.active {
            background: var(--bg-main);
            color: var(--accent-primary);
        }

        .sb-item .material-symbols-rounded {
            color: var(--text-secondary);
            transition: color 0.3s;
        }

        .sb-item:hover .material-symbols-rounded,
        .sb-item.active .material-symbols-rounded {
            color: var(--accent-primary);
        }

        @media (min-width: 768px) {
            .bottom-nav {
                display: none;
            }

            body {
                padding-bottom: 0;
                padding-left: 260px;
            }

            header {
                border-radius: 0 0 24px 24px;
                margin-left: 0;
            }

            .sidebar {
                transform: translateX(0) !important;
                width: 260px !important;
                box-shadow: none !important;
                border-right: 1px solid var(--border-color);
            }

            .sidebar-overlay {
                display: none !important;
            }

            .menu-btn {
                display: none !important;
            }
        }
    </style>
</head>

<body data-theme="light">

    <!-- Sidebar -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sb-header">
            <div style="display: flex; align-items: center; gap: 12px;">
                <img src="logo.png" alt="Logo"
                    style="width: 48px; height: 48px; border-radius: 12px; background: white; padding: 2px;">
                <div>
                    <div style="font-size: 18px; font-weight: bold;">Islamic Hub</div>
                    <div style="font-size: 12px; opacity: 0.9;">v4.0 Premium Edition</div>
                </div>
            </div>
        </div>
        <div class="sb-content no-scrollbar">
            <div class="sb-item" onclick="window.location.href='islamic.html'">
                <span class="material-symbols-rounded">home</span> মূল পাতা
            </div>
            <div class="sb-item active" onclick="window.location.href='quran.html'">
                <span class="material-symbols-rounded">menu_book</span> কুরআন ও হাদিস
            </div>
            <div class="sb-item" onclick="window.location.href='islamic.html'">
                <span class="material-symbols-rounded">history</span> ইতিহাস ও বুকমার্ক
            </div>
            <div class="sb-item" onclick="window.location.href='islamic.html'">
                <span class="material-symbols-rounded">settings</span> সেটিংস
            </div>
            <div style="height: 1px; background: var(--border-color); margin: 16px 0;"></div>
            <div class="sb-item" onclick="toggleTheme()">
                <span class="material-symbols-rounded" id="sbThemeIcon">dark_mode</span> থিম পরিবর্তন
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item" onclick="window.location.href='islamic.html'">
            <span class="material-symbols-rounded">home</span>
            <span>হোম</span>
        </div>
        <div class="nav-item active" onclick="window.location.href='quran.html'">
            <span class="material-symbols-rounded">menu_book</span>
            <span>কুরআন</span>
        </div>
        <div class="nav-item" onclick="window.location.href='islamic.html'">
            <span class="material-symbols-rounded">bookmark</span>
            <span>সেভড</span>
        </div>
        <div class="nav-item" onclick="window.location.href='islamic.html'">
            <span class="material-symbols-rounded">settings</span>
            <span>সেটিংস</span>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="logo">
                <button class="icon-btn menu-btn" onclick="toggleSidebar()"
                    style="padding: 4px; margin-right: 4px; margin-left: -8px;">
                    <span class="material-symbols-rounded">menu</span>
                </button>
                <span class="material-symbols-rounded" onclick="window.location.href='islamic.html'">arrow_back</span>
                কুরআন ও হাদিস
            </div>
            <div style="display:flex; gap:8px;">
                <button class="icon-btn" onclick="toggleTheme()" title="থিম পরিবর্তন"><span
                        class="material-symbols-rounded" id="themeIcon">dark_mode</span></button>
            </div>
        </header>

        <!-- List View -->
        <div id="listView">
            <div class="search-bar" id="searchBarContainer">
                <span class="material-symbols-rounded"
                    style="color:var(--text-secondary); margin-right:12px;">search</span>
                <input type="text" id="searchInput" placeholder="সূরা খুঁজুন (যেমন: ফাতেহা)..."
                    onkeyup="filterSurahs()">
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('quran', this)"><span
                        class="material-symbols-rounded">menu_book</span> আল-কুরআন</div>
                <div class="tab" onclick="switchTab('hadith', this)"><span
                        class="material-symbols-rounded">library_books</span> হাদিস সমূহ</div>
            </div>
            <div style="display:flex; justify-content:flex-end; margin: -4px 0 12px;">
                <button class="btn-action" onclick="resumeLastActivity()">
                    <span class="material-symbols-rounded">resume</span> Start From Last Activity
                </button>
            </div>

            <div class="loader" id="mainLoader">
                <div class="spinner"></div>লোড হচ্ছে...
            </div>
            <div class="grid" id="contentGrid"></div>
        </div>

        <!-- Reader View -->
        <div id="readerView">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <button class="btn-action" style="border-color:var(--accent-primary);" onclick="closeReader()">
                    <span class="material-symbols-rounded">arrow_back</span> ফিরে যান
                </button>
                <div style="display:flex; gap:8px;" id="readerActionButtons">
                    <!-- Auto read & Jump to buttons will be injected here -->
                </div>
            </div>

            <div class="reader-header" id="readerHeader">
                <!-- Populated dynamically -->
            </div>

            <div class="bismillah">بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ</div>

            <div id="ayahsContainer"></div>
        </div>

    </div>

    <div class="toast" id="toast"><span class="material-symbols-rounded">info</span> <span id="toastMsg">বার্তা</span>
    </div>

    <script>
        let allSurahs = [];
        let currentTheme = localStorage.getItem('theme') || 'light';
        let currentTab = 'quran';
        let currentReaderContext = null;
        const readerOptionDefault = { showEnglish: true, showPronunciation: true, audioMode: 'ar' };
        let quranReaderOptions = (() => {
            try {
                const saved = JSON.parse(localStorage.getItem('quranReaderOptions') || '{}');
                return { ...readerOptionDefault, ...saved };
            } catch {
                return { ...readerOptionDefault };
            }
        })();

        function escAttr(v) {
            return String(v || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }

        function saveReaderOptions() {
            localStorage.setItem('quranReaderOptions', JSON.stringify(quranReaderOptions));
        }

        function persistLastActivity(activity) {
            localStorage.setItem('quranLastActivity', JSON.stringify({ ...activity, ts: Date.now() }));
        }

        function resumeLastActivity() {
            try {
                const raw = localStorage.getItem('quranLastActivity');
                if (!raw) {
                    showToast('Last activity পাওয়া যায়নি।');
                    return;
                }
                const activity = JSON.parse(raw);
                if (activity && activity.type === 'quran' && activity.surahId) {
                    openSurah(activity.surahId);
                    if (activity.ayah) {
                        setTimeout(() => {
                            activeReaderItem = parseInt(activity.ayah, 10) || 1;
                            scrollToActiveItem('quran');
                        }, 500);
                    }
                    return;
                }
                if (activity && activity.type === 'hadith' && activity.bookId) {
                    openHadithBook(activity.bookId, activity.bookName || activity.bookId, activity.count || 2000);
                    if (activity.number) {
                        setTimeout(() => {
                            activeReaderItem = parseInt(activity.number, 10) || 1;
                            scrollToActiveItem('hadith');
                        }, 800);
                    }
                    return;
                }
                showToast('Last activity format invalid।');
            } catch (e) {
                showToast('Last activity load ব্যর্থ হয়েছে।');
            }
        }

        function setupHistoryHandling() {
            history.replaceState({ view: 'list', tab: currentTab }, '', location.href);
            window.addEventListener('popstate', (e) => {
                const st = e.state || { view: 'list', tab: currentTab };
                if (st.view === 'reader') {
                    if (st.readerType === 'quran' && st.surahId) {
                        openSurah(st.surahId, true);
                    } else if (st.readerType === 'hadith' && st.bookId) {
                        openHadithBook(st.bookId, st.bookName || st.bookId, st.count || 2000, true);
                    }
                    return;
                }
                closeReader(true);
                if (st.tab === 'hadith') {
                    const hadithTab = document.querySelectorAll('.tab')[1];
                    if (hadithTab) switchTab('hadith', hadithTab);
                } else {
                    const qTab = document.querySelectorAll('.tab')[0];
                    if (qTab) switchTab('quran', qTab);
                }
            });
        }

        async function init() {
            registerServiceWorker();
            if (currentTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('themeIcon').innerText = 'light_mode';
                const sbTheme = document.getElementById('sbThemeIcon');
                if (sbTheme) sbTheme.innerText = 'light_mode';
                const metaColor = document.getElementById('meta-theme-color');
                if (metaColor) metaColor.content = '#064e3b';
            }
            await IslamicModule.init();
            loadQuranList();
            setupHistoryHandling();
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            document.getElementById('themeIcon').innerText = currentTheme === 'dark' ? 'light_mode' : 'dark_mode';

            const sbTheme = document.getElementById('sbThemeIcon');
            if (sbTheme) sbTheme.innerText = currentTheme === 'dark' ? 'light_mode' : 'dark_mode';

            const metaColor = document.getElementById('meta-theme-color');
            if (metaColor) metaColor.content = currentTheme === 'dark' ? '#064e3b' : '#0b5e42';
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                overlay.classList.remove('show');
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('show');
            }
        }

        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                const doRegister = () => navigator.serviceWorker.register('sw.js');
                if (document.readyState === 'complete') doRegister();
                else window.addEventListener('load', doRegister, { once: true });
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3500);
        }

        // --- QURAN TAB ---
        async function loadQuranList() {
            document.getElementById('mainLoader').style.display = 'block';
            document.getElementById('contentGrid').innerHTML = '';

            allSurahs = await IslamicModule.Quran.getMetadata();
            renderSurahList(allSurahs);
            document.getElementById('mainLoader').style.display = 'none';

            // Check offline status for each asynchronously
            allSurahs.forEach(async s => {
                const req = indexedDB.open('IslamicKnowledgeCoreStore', 1);
                req.onsuccess = e => {
                    const db = e.target.result;
                    if (db.objectStoreNames.contains('surahs')) {
                        const tx = db.transaction('surahs', 'readonly');
                        const getReq = tx.objectStore('surahs').get(s.number);
                        getReq.onsuccess = () => {
                            if (getReq.result && getReq.result.isComplete) {
                                const card = document.getElementById(`surah-card-${s.number}`);
                                if (card) card.classList.add('is-offline');
                            }
                        };
                    }
                };
            });
        }

        function renderSurahList(list) {
            const grid = document.getElementById('contentGrid');
            if (list.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:40px; color:var(--text-secondary);">কিছু পাওয়া যায়নি</div>';
                return;
            }

            grid.innerHTML = list.map(s => `
            <div class="surah-card" id="surah-card-${s.number}" onclick="openSurah(${s.number})">
                <div style="display:flex; align-items:center; gap:16px;">
                    <div class="surah-num">${s.number}</div>
                    <div>
                        <div class="surah-name">${s.englishName} <span class="offline-badge"><span class="material-symbols-rounded" style="font-size:12px;">cloud_done</span> অফলাইন</span></div>
                        <div class="surah-sub">${s.name} • ${s.numberOfAyahs} Ayahs • ${s.revelationType === 'Meccan' ? 'মাক্কী' : 'মাদানী'}</div>
                    </div>
                </div>
            </div>
        `).join('');
        }

        function filterSurahs() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allSurahs.filter(s =>
                s.englishName.toLowerCase().includes(query) ||
                s.name.includes(query) ||
                s.number.toString() === query
            );
            renderSurahList(filtered);
        }

        let isAutoReading = false;
        let activeReaderItem = 0; // Ayah or Hadith number
        let maxReaderItems = 0;
        let readerDataType = 'quran'; // 'quran' or 'hadith'

        // --- READER VIEW ---
        async function openSurah(id, fromHistory = false) {
            document.getElementById('listView').style.display = 'none';
            document.getElementById('readerView').style.display = 'block';
            document.getElementById('readerHeader').innerHTML = '<div class="spinner"></div>লোড হচ্ছে...';
            document.getElementById('ayahsContainer').innerHTML = '';
            window.scrollTo(0, 0);
            currentTab = 'quran';

            if (!fromHistory) {
                history.pushState({ view: 'reader', readerType: 'quran', surahId: id, tab: 'quran' }, '', `#surah-${id}`);
            }

            try {
                const surah = await IslamicModule.Quran.getSurah(id);
                if (!surah) { showToast("তথ্য লোড করতে সমস্যা হয়েছে! ইন্টারনেট সংযোগ চেক করুন।"); closeReader(); return; }

                // Render Header
                document.getElementById('readerHeader').innerHTML = `
                <div style="position:relative;">
                    <!-- Auto Read and Jump buttons setup -->
                    <button class="btn-action dl-btn" onclick="saveSurahOffline(${id}, this)" id="surahDlBtn-${id}" style="position:absolute; top:0; right:0;">
                        <span class="material-symbols-rounded">download</span> অফলাইন সেভ
                    </button>
                    <span class="offline-badge" id="reader-offline-badge" style="display:none; position:absolute; top:0; right:0; font-size:14px; padding:6px 12px; border-radius:20px;">
                        <span class="material-symbols-rounded" style="font-size:16px;">cloud_done</span> অফলাইনে সংরক্ষিত
                    </span>
                </div>
                <h1 style="font-size:28px; color:var(--accent-primary); margin-top:28px;">${surah.englishName}</h1>
                <div style="font-size:18px; font-family:'Amiri', serif; margin:8px 0;">${surah.name}</div>
                <div style="color:var(--text-secondary); font-size:14px;">${surah.englishNameTranslation} • ${surah.ayahs.length} Ayahs</div>
                <div class="reader-toggle-group">
                    <button class="toggle-chip ${quranReaderOptions.showPronunciation ? 'active' : ''}" id="togglePronBtn" onclick="toggleQuranLayer('showPronunciation')">উচ্চারণ</button>
                    <button class="toggle-chip ${quranReaderOptions.showEnglish ? 'active' : ''}" id="toggleEnglishBtn" onclick="toggleQuranLayer('showEnglish')">English</button>
                    <button class="toggle-chip ${quranReaderOptions.audioMode === 'ar' ? 'active' : ''}" id="audioModeArBtn" onclick="setQuranAudioMode('ar')">Auto: Arabic</button>
                    <button class="toggle-chip ${quranReaderOptions.audioMode === 'bn' ? 'active' : ''}" id="audioModeBnBtn" onclick="setQuranAudioMode('bn')">Auto: Bangla</button>
                    <button class="toggle-chip ${quranReaderOptions.audioMode === 'en' ? 'active' : ''}" id="audioModeEnBtn" onclick="setQuranAudioMode('en')">Auto: English</button>
                </div>
            `;

                // Inject Top Actions
                document.getElementById('readerActionButtons').innerHTML = `
                   <!-- Add Font Size & Share Controls within Quran Reader -->
                   <button class="icon-btn" style="background:var(--bg-main);" onclick="changeFontSize('ayahsContainer', -1)" title="ফন্ট ছোট করুন">
                       <span class="material-symbols-rounded">text_decrease</span>
                   </button>
                   <button class="icon-btn" style="background:var(--bg-main);" onclick="changeFontSize('ayahsContainer', 1)" title="ফন্ট বড় করুন">
                       <span class="material-symbols-rounded">text_increase</span>
                   </button>
                   <button class="icon-btn" style="background:var(--bg-main);" onclick="captureAndDownload('readerView', 'Surah_${surah.englishName}')" title="ইমেজ ডাউনলোড">
                       <span class="material-symbols-rounded">download</span>
                   </button>
                   <button class="icon-btn" style="background:var(--bg-main);" onclick="promptJumpTo('quran', ${surah.ayahs.length})" title="Jump to Ayah">
                       <span class="material-symbols-rounded">low_priority</span>
                   </button>
                   <button class="icon-btn" style="background:var(--bg-main); color:var(--accent-primary);" onclick="startAutoRead('quran')" id="autoReadBtn" title="Auto Read">
                       <span class="material-symbols-rounded">autoplay</span>
                   </button>
                   <button class="icon-btn" style="background:var(--bg-main);" onclick="resumeLastActivity()" title="Last Activity">
                       <span class="material-symbols-rounded">resume</span>
                   </button>
                `;

                readerDataType = 'quran';
                activeReaderItem = 1;
                maxReaderItems = surah.ayahs.length;
                currentReaderContext = { type: 'quran', surahId: id, ayah: 1, count: surah.ayahs.length };
                persistLastActivity(currentReaderContext);

                // Check if already offline saved
                const dbReq = indexedDB.open('IslamicKnowledgeCoreStore', 1);
                dbReq.onsuccess = e => {
                    const db = e.target.result;
                    const getReq = db.transaction('surahs', 'readonly').objectStore('surahs').get(id);
                    getReq.onsuccess = () => {
                        if (getReq.result && getReq.result.isComplete) {
                            const dlBtn = document.getElementById(`surahDlBtn-${id}`);
                            if (dlBtn) dlBtn.style.display = 'none';
                            document.getElementById('reader-offline-badge').style.display = 'inline-flex';
                        }
                    };
                };

                // Render Ayahs
                const ayahsHtml = surah.ayahs.map(a => `
                <div class="ayah-card" id="ayah-${a.numberInSurah}">
                    <div class="ayah-header">
                        <span style="font-weight:bold; color:var(--text-secondary); background:var(--bg-main); padding:4px 12px; border-radius:20px;">আয়াত ${a.numberInSurah}</span>
                        <div style="display:flex; gap:8px;">
                            <button class="icon-btn" data-role="quran-ar" style="background:var(--bg-main);" onclick="IslamicModule.UI.playAudio('${escAttr(a.audio)}', this)" title="আরবি অডিও">
                                <span class="material-symbols-rounded">play_circle</span>
                            </button>
                            <button class="icon-btn" data-role="quran-bn" style="background:var(--bg-main);" onclick="IslamicModule.UI.playTTS('${escAttr(a.bangla)}', this, 'bn-BD')" title="বাংলা অডিও">
                                <span class="material-symbols-rounded">record_voice_over</span>
                            </button>
                            <button class="icon-btn" data-role="quran-en" style="background:var(--bg-main); ${a.english ? '' : 'display:none;'}" onclick="IslamicModule.UI.playTTS('${escAttr(a.english)}', this, 'en-US')" title="English Audio">
                                <span class="material-symbols-rounded">translate</span>
                            </button>
                            <button class="icon-btn" style="background:var(--bg-main);" onclick="navigator.clipboard.writeText('${escAttr(a.arabic)}\\n\\n${escAttr(a.transliteration || '')}\\n\\n${escAttr(a.bangla)}\\n\\n${escAttr(a.english || '')}')" title="কপি করুন">
                                <span class="material-symbols-rounded">content_copy</span>
                            </button>
                        </div>
                    </div>
                    <div class="ayah-arabic">${a.arabic} ۝</div>
                    <div class="ayah-pronunciation q-layer-pron" style="${quranReaderOptions.showPronunciation ? '' : 'display:none;'}">${a.transliteration || 'Transliteration unavailable'}</div>
                    <div class="ayah-bangla">${a.bangla}</div>
                    <div class="ayah-english q-layer-en" style="${quranReaderOptions.showEnglish ? '' : 'display:none;'}">${a.english || 'English translation unavailable'}</div>
                </div>
            `).join('');

                document.getElementById('ayahsContainer').innerHTML = ayahsHtml;
                applyQuranReaderOptions();

            } catch (e) {
                console.error(e);
                showToast("লোড করতে ত্রুটি হয়েছে।");
                closeReader();
            }
        }

        async function saveSurahOffline(id, btnElement) {
            btnElement.innerHTML = '<span class="material-symbols-rounded">hourglass_empty</span> সেভ হচ্ছে...';
            btnElement.style.pointerEvents = 'none';

            // Just calling getSurah fetches and saves it to indexedDB
            const surah = await IslamicModule.Quran.getSurah(id);

            if (surah) {
                btnElement.style.display = 'none';
                document.getElementById('reader-offline-badge').style.display = 'inline-flex';
                const listCard = document.getElementById(`surah-card-${id}`);
                if (listCard) listCard.classList.add('is-offline');
                showToast(`${surah.englishName} অফলাইনে সেভ করা হয়েছে!`);
            } else {
                showToast("সেভ করতে ব্যর্থ হয়েছে। ইন্টারনেট সংযোগ চেক করুন।");
                btnElement.innerHTML = '<span class="material-symbols-rounded">download</span> অফলাইন সেভ';
                btnElement.style.pointerEvents = 'auto';
            }
        }

        function applyQuranReaderOptions() {
            const pron = document.querySelectorAll('.q-layer-pron');
            const en = document.querySelectorAll('.q-layer-en');
            pron.forEach(el => el.style.display = quranReaderOptions.showPronunciation ? 'block' : 'none');
            en.forEach(el => el.style.display = quranReaderOptions.showEnglish ? 'block' : 'none');

            const togglePronBtn = document.getElementById('togglePronBtn');
            const toggleEnglishBtn = document.getElementById('toggleEnglishBtn');
            const modeAr = document.getElementById('audioModeArBtn');
            const modeBn = document.getElementById('audioModeBnBtn');
            const modeEn = document.getElementById('audioModeEnBtn');
            if (togglePronBtn) togglePronBtn.classList.toggle('active', !!quranReaderOptions.showPronunciation);
            if (toggleEnglishBtn) toggleEnglishBtn.classList.toggle('active', !!quranReaderOptions.showEnglish);
            if (modeAr) modeAr.classList.toggle('active', quranReaderOptions.audioMode === 'ar');
            if (modeBn) modeBn.classList.toggle('active', quranReaderOptions.audioMode === 'bn');
            if (modeEn) modeEn.classList.toggle('active', quranReaderOptions.audioMode === 'en');
        }

        function toggleQuranLayer(key) {
            quranReaderOptions[key] = !quranReaderOptions[key];
            saveReaderOptions();
            applyQuranReaderOptions();
        }

        function setQuranAudioMode(mode) {
            quranReaderOptions.audioMode = mode;
            saveReaderOptions();
            applyQuranReaderOptions();
            showToast(`Auto Read mode: ${mode === 'ar' ? 'Arabic Audio' : mode === 'bn' ? 'Bangla Meaning Audio' : 'English Audio'}`);
        }

        function closeReader(fromHistory = false) {
            if (!fromHistory && history.state && history.state.view === 'reader') {
                history.back();
                return;
            }
            document.getElementById('readerView').style.display = 'none';
            document.getElementById('listView').style.display = 'block';
            isAutoReading = false;
            if (IslamicModule.UI.currentAudio) IslamicModule.UI.currentAudio.pause();
            if (window.Logic && window.Logic.isSpeaking) window.Logic.stopSpeak();
            else if ('speechSynthesis' in window) window.speechSynthesis.cancel();
        }


        // --- HADITH TAB ---
        async function loadHadithList() {
            document.getElementById('mainLoader').style.display = 'block';
            document.getElementById('contentGrid').innerHTML = '';

            const books = await IslamicModule.Hadith.getBookList();
            renderHadithBooks(books);
            document.getElementById('mainLoader').style.display = 'none';
        }

        function renderHadithBooks(books) {
            const grid = document.getElementById('contentGrid');
            grid.innerHTML = books.map(b => `
                <div class="surah-card" id="hadith-book-${b.id}" style="${b.isDownloaded ? 'border-left: 4px solid #10b981;' : ''}">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">
                        <div>
                            <div class="surah-name" style="color:var(--text-primary); margin-bottom:4px;">${b.name}</div>
                            <div class="surah-sub">${b.count} টি হাদিস</div>
                        </div>
                        <div style="background:#fef3c7; color:#b45309; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:12px;">
                             <span class="material-symbols-rounded">library_books</span>
                        </div>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; border-top:1px dashed var(--border-color); padding-top:12px; margin-top:8px;">
                         ${b.isDownloaded ? `
                             <span style="font-size:12px; color:#10b981; font-weight:bold; display:flex; align-items:center; gap:4px;">
                                 <span class="material-symbols-rounded" style="font-size:16px;">check_circle</span> অফলাইনে সেভ করা
                             </span>
                             <button class="embed-btn" onclick="openHadithBook('${b.id}', '${b.name}', ${b.count})" style="color:var(--accent-primary); border-color:var(--accent-primary);">
                                 পড়ুন <span class="material-symbols-rounded" style="font-size:16px;">arrow_forward</span>
                             </button>
                         ` : `
                             <span style="font-size:12px; color:var(--text-secondary);" id="dl-status-${b.id}">ইন্টারনেট প্রয়োজন</span>
                             <button class="embed-btn" id="dl-btn-${b.id}" onclick="startHadithDownload('${b.id}')">
                                 <span class="material-symbols-rounded" style="font-size:16px;">download</span> ডাউনলোড
                             </button>
                         `}
                    </div>
                    <div class="dl-progress-bar" id="progress-bar-container-${b.id}" style="display:none; margin-top:12px; height:4px; background:var(--border-color); border-radius:2px; overflow:hidden;">
                         <div id="progress-bar-${b.id}" style="height:100%; width:0%; background:var(--accent-primary); transition:width 0.3s;"></div>
                    </div>
                </div>
            `).join('');
        }

        async function startHadithDownload(bookId) {
            const btn = document.getElementById(`dl-btn-${bookId}`);
            const status = document.getElementById(`dl-status-${bookId}`);
            const pbContainer = document.getElementById(`progress-bar-container-${bookId}`);
            const pb = document.getElementById(`progress-bar-${bookId}`);

            btn.style.display = 'none';
            pbContainer.style.display = 'block';

            const success = await IslamicModule.Hadith.downloadBook(bookId, (percent, msg) => {
                if (percent >= 0) pb.style.width = percent + '%';
                status.innerText = msg;
                status.style.color = 'var(--text-primary)';
            });

            if (success) {
                showToast("হাদিস বই ডাউনলোড সফল হয়েছে!");
                loadHadithList(); // reload grid
            } else {
                pbContainer.style.display = 'none';
                btn.style.display = 'flex';
                status.style.color = 'red';
            }
        }

        // --- Hadith Reader Logic (Pagination/Virtualization to follow) ---
        async function openHadithBook(bookId, bookName, count, fromHistory = false) {
            document.getElementById('listView').style.display = 'none';
            document.getElementById('readerView').style.display = 'block';
            currentTab = 'hadith';
            if (!fromHistory) {
                history.pushState({ view: 'reader', readerType: 'hadith', bookId, bookName, count, tab: 'hadith' }, '', `#hadith-${bookId}`);
            }

            document.getElementById('readerHeader').innerHTML = `
                <h1 style="font-size:24px; color:var(--accent-primary); margin-top:28px;">${bookName}</h1>
                <div style="color:var(--text-secondary); font-size:14px;">মোট ${count} টি হাদিস</div>
            `;

            document.getElementById('readerActionButtons').innerHTML = `
               <button class="icon-btn" style="background:var(--bg-main);" onclick="changeFontSize('ayahsContainer', -1)" title="ফন্ট ছোট করুন">
                   <span class="material-symbols-rounded">text_decrease</span>
               </button>
               <button class="icon-btn" style="background:var(--bg-main);" onclick="changeFontSize('ayahsContainer', 1)" title="ফন্ট বড় করুন">
                   <span class="material-symbols-rounded">text_increase</span>
               </button>
               <button class="icon-btn" style="background:var(--bg-main);" onclick="captureAndDownload('readerView', 'Hadith_${bookName}')" title="ইমেজ ডাউনলোড">
                   <span class="material-symbols-rounded">download</span>
               </button>
               <button class="icon-btn" style="background:var(--bg-main);" onclick="promptJumpTo('hadith', ${count})" title="Jump to Hadith">
                   <span class="material-symbols-rounded">low_priority</span>
               </button>
               <button class="icon-btn" style="background:var(--bg-main); color:var(--accent-primary);" onclick="startAutoRead('hadith')" id="autoReadBtn" title="Auto Read">
                   <span class="material-symbols-rounded">autoplay</span>
               </button>
            `;

            document.getElementById('ayahsContainer').innerHTML = `
                <div style="padding:40px; text-align:center; color:var(--text-secondary);">
                    <div class="spinner"></div> লোড হচ্ছে...
                </div>
            `;

            readerDataType = 'hadith';
            activeReaderItem = 1;
            maxReaderItems = count;
            currentReaderContext = { type: 'hadith', bookId, bookName, count, number: 1 };
            persistLastActivity(currentReaderContext);

            // Render first 50 hadiths for performance
            renderHadithRange(bookId, bookName, 1, 50, true);
        }

        async function renderHadithRange(bookId, bookName, start, end, clear = false) {
            const container = document.getElementById('ayahsContainer');
            if (clear) container.innerHTML = '';

            let html = '';
            for (let i = start; i <= end; i++) {
                // Fast offline fetch from indexedDB
                const h = await IslamicModule.Hadith.getHadith(bookId, i);
                if (h) {
                    const safeText = h.bangla.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    html += `
                        <div class="ayah-card" id="hadith-${i}">
                            <div class="ayah-header">
                                <span style="font-weight:bold; color:var(--text-secondary); background:var(--bg-main); padding:4px 12px; border-radius:20px;">হাদিস নং ${i}</span>
                                <div style="display:flex; gap:8px;">
                                    <span style="font-size:12px; background:#fef3c7; color:#b45309; padding:2px 8px; border-radius:12px; display:flex; align-items:center;">${h.grade}</span>
                                    <button class="icon-btn" data-role="hadith-tts" style="background:var(--bg-main);" onclick="IslamicModule.UI.playTTS('${safeText}', this, 'bn-BD')" title="শুনুন">
                                        <span class="material-symbols-rounded" style="font-size:18px;">record_voice_over</span>
                                    </button>
                                </div>
                            </div>
                            <div class="ayah-bangla">${h.bangla}</div>
                        </div>
                     `;
                }
            }

            if (html === '') html = '<div style="text-align:center; padding:20px;">এই রেঞ্জের হাদিস পাওয়া যায়নি।</div>';

            // Append or set HTML (ideally we should use virtual scrolling for 7000 items, but for now we append chunks)
            container.innerHTML += html;

            // Add load more button if we haven't reached the end
            if (end < maxReaderItems) {
                const nextEnd = Math.min(end + 50, maxReaderItems);
                container.innerHTML += `
                    <button class="btn-action" id="loadMoreBtn-${end}" style="width:100%; justify-content:center; margin-top:20px; padding:12px;" onclick="
                        this.style.display='none'; 
                        renderHadithRange('${bookId}', '${bookName}', ${end + 1}, ${nextEnd}, false);
                    ">
                        আরও দেখুন (হাদিস ${end + 1} - ${nextEnd})
                    </button>
                 `;
            }
        }

        // --- Shared Reader Actions (Jump & AutoRead) ---
        function promptJumpTo(type, max) {
            const num = prompt(`Enter ${type === 'quran' ? 'Ayah' : 'Hadith'} number (1 - ${max}):`);
            if (num && !isNaN(num) && num > 0 && num <= max) {
                activeReaderItem = parseInt(num);
                if (currentReaderContext) {
                    if (type === 'quran') currentReaderContext.ayah = activeReaderItem;
                    else currentReaderContext.number = activeReaderItem;
                    persistLastActivity(currentReaderContext);
                }
                scrollToActiveItem(type);
            }
        }

        function scrollToActiveItem(type) {
            const targetId = type === 'quran' ? `ayah-${activeReaderItem}` : `hadith-${activeReaderItem}`;
            const el = document.getElementById(targetId);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.style.transition = 'background 0.5s';
                const oldBg = el.style.background;
                el.style.background = 'var(--mag-3-bg)';
                setTimeout(() => { el.style.background = oldBg; }, 2000);
            } else {
                if (type === 'hadith') {
                    showToast('হাদিসটি এখনো লোড হয়নি, "আরও দেখুন" এ ক্লিক করুন।');
                }
            }
        }

        function startAutoRead(type) {
            const btn = document.getElementById('autoReadBtn');
            if (isAutoReading) {
                // Stop Auto Read
                isAutoReading = false;
                btn.innerHTML = '<span class="material-symbols-rounded">autoplay</span>';
                btn.style.color = 'var(--accent-primary)';
                if (type === 'quran' && IslamicModule.UI.currentAudio) IslamicModule.UI.currentAudio.pause();
                if (window.Logic && window.Logic.isSpeaking) window.Logic.stopSpeak();
                else if ('speechSynthesis' in window) window.speechSynthesis.cancel();
                showToast('অটো-রিড বন্ধ করা হয়েছে।');
            } else {
                // Start Auto Read
                isAutoReading = true;
                btn.innerHTML = '<span class="material-symbols-rounded">stop_circle</span>';
                btn.style.color = '#ef4444'; // Red
                showToast('অটো-রিড শুরু হয়েছে...');
                playNextAutoReadItem(type);
            }
        }

        function playNextAutoReadItem(type) {
            if (!isAutoReading) return;
            if (activeReaderItem > maxReaderItems) {
                startAutoRead(type); // Toggle off
                showToast('অটো-রিড শেষ হয়েছে।');
                return;
            }

            // Ensure element is visible
            scrollToActiveItem(type);

            const targetId = type === 'quran' ? `ayah-${activeReaderItem}` : `hadith-${activeReaderItem}`;
            const el = document.getElementById(targetId);

            if (!el) {
                // We need to load more
                const loadMoreBtn = document.querySelector('[id^="loadMoreBtn-"]');
                if (loadMoreBtn && loadMoreBtn.style.display !== 'none') {
                    loadMoreBtn.click();
                    // Wait a bit for DOM to render before trying again
                    setTimeout(() => playNextAutoReadItem(type), 1000);
                    return;
                }
            }

            // Find and click the play button inside the item
            if (el) {
                let selector = '.icon-btn';
                if (type === 'quran') {
                    const mode = quranReaderOptions.audioMode || 'ar';
                    selector = mode === 'bn' ? '.icon-btn[data-role="quran-bn"]' : (mode === 'en' ? '.icon-btn[data-role="quran-en"]' : '.icon-btn[data-role="quran-ar"]');
                } else {
                    selector = '.icon-btn[data-role="hadith-tts"], .icon-btn';
                }
                const playBtn = el.querySelector(selector);
                if (playBtn) {
                    // Listen for specific end events to trigger next
                    if (type === 'quran') {
                        const mode = quranReaderOptions.audioMode || 'ar';
                        playBtn.click();
                        if (mode === 'ar') checkQuranAudioEnd();
                        else checkTTSEnd('quran');
                    } else {
                        // TTS
                        playBtn.click();
                        checkTTSEnd('hadith');
                    }
                } else {
                    // Skip if no audio
                    activeReaderItem++;
                    playNextAutoReadItem(type);
                }
            }
        }

        function checkQuranAudioEnd() {
            if (!isAutoReading) return;
            if (IslamicModule.UI.currentAudio) {
                const originalOnEnded = IslamicModule.UI.currentAudio.onended;
                IslamicModule.UI.currentAudio.onended = () => {
                    if (originalOnEnded) originalOnEnded();
                    if (isAutoReading) {
                        activeReaderItem++;
                        if (currentReaderContext) {
                            currentReaderContext.ayah = activeReaderItem;
                            persistLastActivity(currentReaderContext);
                        }
                        // Small delay before next ayah
                        setTimeout(() => playNextAutoReadItem('quran'), 800);
                    }
                };
            }
        }

        function checkTTSEnd(type) {
            if (!isAutoReading) return;
            // Native speech synthesis event hijacking is tricky due to Logic.js override.
            // A simple poll is safer if we don't want to modify core Logic heavily
            const poll = setInterval(() => {
                if (!isAutoReading) {
                    clearInterval(poll);
                    return;
                }
                const isSpeaking = (window.Logic && window.Logic.isSpeaking) || window.speechSynthesis.speaking;
                if (!isSpeaking) {
                    clearInterval(poll);
                    activeReaderItem++;
                    if (currentReaderContext) {
                        if (readerDataType === 'quran') currentReaderContext.ayah = activeReaderItem;
                        else currentReaderContext.number = activeReaderItem;
                        persistLastActivity(currentReaderContext);
                    }
                    setTimeout(() => playNextAutoReadItem(type || readerDataType), 800);
                }
            }, 500);
        }

        function switchTab(tabId, el) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            currentTab = tabId;
            if (history.state && history.state.view === 'list') {
                history.replaceState({ view: 'list', tab: currentTab }, '', location.href);
            }

            if (tabId === 'hadith') {
                document.getElementById('searchBarContainer').style.display = 'none';
                loadHadithList();
            } else {
                document.getElementById('searchBarContainer').style.display = 'block';
                filterSurahs();
            }
        }

        // --- GLOBAL FEATURES (Font Size, Download Card) ---
        function changeFontSize(containerId, step) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // We adjust the .ayah-arabic and .ayah-bangla within the container
            const arabics = container.querySelectorAll('.ayah-arabic');
            const banglas = container.querySelectorAll('.ayah-bangla');
            const prons = container.querySelectorAll('.ayah-pronunciation');
            const english = container.querySelectorAll('.ayah-english');

            arabics.forEach(el => {
                let currentSize = parseInt(window.getComputedStyle(el).fontSize);
                if (isNaN(currentSize)) currentSize = 28;
                let newSize = currentSize + (step * 2);
                if (newSize >= 18 && newSize <= 40) el.style.fontSize = newSize + 'px';
            });

            banglas.forEach(el => {
                let currentSize = parseInt(window.getComputedStyle(el).fontSize);
                if (isNaN(currentSize)) currentSize = 16;
                let newSize = currentSize + (step * 2);
                if (newSize >= 12 && newSize <= 28) el.style.fontSize = newSize + 'px';
            });

            prons.forEach(el => {
                let currentSize = parseInt(window.getComputedStyle(el).fontSize);
                if (isNaN(currentSize)) currentSize = 15;
                let newSize = currentSize + (step * 2);
                if (newSize >= 12 && newSize <= 26) el.style.fontSize = newSize + 'px';
            });

            english.forEach(el => {
                let currentSize = parseInt(window.getComputedStyle(el).fontSize);
                if (isNaN(currentSize)) currentSize = 15;
                let newSize = currentSize + (step * 2);
                if (newSize >= 12 && newSize <= 26) el.style.fontSize = newSize + 'px';
            });
        }

        async function captureAndDownload(elementId, filename) {
            const el = document.getElementById(elementId);
            if (!el) return;

            showToast('ছবি তৈরি করা হচ্ছে, অনুগ্রহ করে অপেক্ষা করুন...');

            // Temporarily hide action buttons to keep screenshot clean
            const actionBtns = el.querySelectorAll('.icon-btn, .btn-action');
            actionBtns.forEach(b => b.style.display = 'none');

            try {
                const canvas = await html2canvas(el, {
                    scale: 2,
                    backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-surface'),
                    useCORS: true
                });

                const url = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = url;
                a.download = filename + "_" + Date.now() + ".png";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                showToast('ডাউনলোড সফল হয়েছে!');
            } catch (e) {
                console.error("Download Error:", e);
                showToast('ফটো ডাউনলোডে সমস্যা হয়েছে।');
            } finally {
                // Restore buttons
                actionBtns.forEach(b => b.style.display = '');
            }
        }

        window.onload = init;
    </script>
</body>

</html>
