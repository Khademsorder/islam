<!DOCTYPE html>
<html lang="bn">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <script>
    window.onerror = function (msg, url, lineNo, columnNo, error) {
      alert("Error: " + msg + "\nLine: " + lineNo + "\nCol: " + columnNo);
      return false;
    };
    window.addEventListener('unhandledrejection', function (event) {
      alert("Promise Rejection: " + (event.reason && event.reason.message ? event.reason.message : event.reason));
    });
  </script>
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self' data: blob: https:; script-src 'self' 'unsafe-inline' https://code.responsivevoice.org https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; connect-src 'self' https:; media-src 'self' blob: data: https:; img-src 'self' data: blob: https:;">
  <title>‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶ú‡ßç‡¶û‡¶æ‡¶® ¬∑ ‡¶Ü‡¶≤‡ßç‡¶ü‡¶ø‡¶Æ‡ßá‡¶ü ‡¶è‡¶°‡¶ø‡¶∂‡¶® (v4.0)</title>

  <!-- Fonts & Icons -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0,1" />
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700;800&family=Amiri:wght@400;700&family=Scheherazade+New:wght@400;700&display=swap"
    rel="stylesheet">
  <!-- ResponsiveVoice for TTS -->
  <script src="https://code.responsivevoice.org/responsivevoice.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Add html2canvas for image generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- PWA & Native App Meta Tags -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b5e42" id="meta-theme-color">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="logo.png">

  <style>
    /* ==================================================
       [1] PURE CSS VARIABLES & THEME ENGINE
       ================================================== */
    :root {
      --bg-main: #f4f7f6;
      --bg-surface: #ffffff;
      --text-primary: #1f2937;
      --text-secondary: #4b5563;
      --border-color: #e5e7eb;
      --accent-primary: #0b5e42;
      --accent-hover: #084c35;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 8px 16px rgba(0, 0, 0, 0.1);
      --mag-font-size: 16px;

      /* Magazine 12 Color System (Light) */
      --mag-1-bg: #e8f5e9;
      --mag-1-border: #81c784;
      --mag-2-bg: #fce4ec;
      --mag-2-border: #f06292;
      --mag-3-bg: #e3f2fd;
      --mag-3-border: #64b5f6;
      --mag-4-bg: #fff3e0;
      --mag-4-border: #ffb74d;
      --mag-5-bg: #f3e5f5;
      --mag-5-border: #ba68c8;
      --mag-6-bg: #e0f2f1;
      --mag-6-border: #4db6ac;
      --mag-7-bg: #fbe9e7;
      --mag-7-border: #ff8a65;
      --mag-8-bg: #f0f4c3;
      --mag-8-border: #aed581;
      --mag-9-bg: #ffebee;
      --mag-9-border: #e57373;
      --mag-10-bg: #e8eaf6;
      --mag-10-border: #7986cb;
      --mag-11-bg: #e0f7fa;
      --mag-11-border: #4dd0e1;
      --mag-12-bg: #fdf2f8;
      --mag-12-border: #f472b6;
    }

    [data-theme="dark"] {
      --bg-main: #0f172a;
      --bg-surface: #1e293b;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --border-color: #334155;
      --accent-primary: #10b981;
      --accent-hover: #059669;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 8px 16px rgba(0, 0, 0, 0.5);

      --mag-1-bg: #064e3b;
      --mag-1-border: #059669;
      --mag-2-bg: #1e3a8a;
      --mag-2-border: #2563eb;
      --mag-3-bg: #78350f;
      --mag-3-border: #d97706;
      --mag-4-bg: #4c1d95;
      --mag-4-border: #7c3aed;
      --mag-5-bg: #134e4a;
      --mag-5-border: #0d9488;
      --mag-6-bg: #7f1d1d;
      --mag-6-border: #dc2626;
      --mag-7-bg: #831843;
      --mag-7-border: #e11d48;
      --mag-8-bg: #334155;
      --mag-8-border: #64748b;
      --mag-9-bg: #3f6212;
      --mag-9-border: #65a30d;
      --mag-10-bg: #312e81;
      --mag-10-border: #4f46e5;
      --mag-11-bg: #0c4a6e;
      --mag-11-border: #38bdf8;
      --mag-12-bg: #831843;
      --mag-12-border: #f472b6;
    }

    /* ==================================================[2] CORE STYLES & ANIMATIONS
       ================================================== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Noto Sans Bengali', sans-serif;
      background-color: var(--bg-main);
      color: var(--text-primary);
      transition: background-color 0.4s ease, color 0.4s ease;
      line-height: 1.6;
      overflow-x: hidden;
    }

    button,
    input,
    select {
      font-family: inherit;
      outline: none;
      border: none;
    }

    .container {
      margin: 0 auto;
      padding: 0 16px;
      max-width: 900px;
    }

    /* Animations */
    @keyframes slideDown {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes fadeInScale {
      from {
        transform: scale(0.95);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes pulseGlow {
      0% {
        box-shadow: 0 0 0 0 rgba(11, 94, 66, 0.4);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(11, 94, 66, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(11, 94, 66, 0);
      }
    }

    /* Header */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: var(--bg-surface);
      border-bottom: 2px solid var(--accent-primary);
      border-radius: 0 0 24px 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-sm);
      animation: slideDown 0.5s ease;
    }

    .logo {
      font-size: 22px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--accent-primary);
    }

    .icon-btn {
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 10px;
      border-radius: 50%;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-btn:hover {
      background: var(--border-color);
      transform: scale(1.1) rotate(5deg);
      color: var(--accent-primary);
    }

    /* Search Bar */
    .search-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--bg-surface);
      border: 2px solid transparent;
      border-radius: 50px;
      padding: 6px 16px;
      box-shadow: var(--shadow-md);
      margin-bottom: 24px;
      transition: all 0.3s ease;
      animation: fadeInScale 0.6s ease;
    }

    .search-wrapper:focus-within {
      border-color: var(--accent-primary);
      transform: translateY(-2px);
    }

    .search-input {
      flex: 1;
      font-size: 16px;
      background: transparent;
      color: var(--text-primary);
      padding: 12px 0;
      width: 100%;
    }

    .action-btn {
      background: var(--accent-primary);
      color: #fff;
      padding: 12px 24px;
      border-radius: 50px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(11, 94, 66, 0.3);
    }

    .action-btn:hover {
      transform: translateY(-2px);
      background: var(--accent-hover);
      box-shadow: 0 6px 16px rgba(11, 94, 66, 0.4);
    }

    #imageInput {
      display: none;
    }

    .vision-indicator {
      display: none;
      padding: 6px 12px;
      background: var(--mag-3-bg);
      color: var(--text-primary);
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      border: 1px solid var(--mag-3-border);
      animation: slideDown 0.3s ease;
    }

    .mic-active {
      color: #ef4444 !important;
      animation: pulseGlow 1.5s infinite;
    }

    /* Category Scroll (Fixed & Draggable) */
    .cat-scroll-container {
      position: relative;
      margin-bottom: 24px;
      animation: slideUp 0.7s ease;
    }

    .cat-scroll {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 12px;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      cursor: grab;
    }

    .cat-scroll:active {
      cursor: grabbing;
    }

    .cat-scroll::-webkit-scrollbar {
      height: 6px;
    }

    .cat-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .cat-scroll::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 10px;
    }

    .cat-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    .cat-chip {
      padding: 10px 20px;
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: 50px;
      cursor: pointer;
      white-space: nowrap;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
      user-select: none;
    }

    .cat-chip:hover {
      transform: translateY(-2px);
      border-color: var(--accent-primary);
    }

    .cat-chip.active {
      background: var(--accent-primary);
      color: #fff;
      border-color: var(--accent-primary);
      box-shadow: 0 4px 12px rgba(11, 94, 66, 0.3);
    }

    .suggestion-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .suggestion-card {
      width: 100%;
      min-height: 56px;
      border: 1px solid transparent;
      border-radius: 14px;
      padding: 12px 14px;
      text-align: left;
      font-size: 14px;
      font-weight: 700;
      line-height: 1.4;
      cursor: pointer;
      transition: transform .2s ease, box-shadow .2s ease;
      box-shadow: var(--shadow-sm);
      word-break: break-word;
    }

    .suggestion-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    /* Question Grid */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
      padding-bottom: 40px;
    }

    .q-card {
      background: var(--bg-surface);
      padding: 20px;
      border-radius: 20px;
      border: 1px solid var(--border-color);
      text-align: center;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      animation: fadeInScale 0.5s ease backwards;
    }

    .q-card:hover {
      transform: translateY(-6px);
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-md);
    }

    .q-card span.material-symbols-rounded {
      color: var(--accent-primary);
      font-size: 36px;
      transition: transform 0.3s ease;
    }

    .q-card:hover span.material-symbols-rounded {
      transform: scale(1.1);
    }

    /* Gamified Loader */
    .loader-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      z-index: 1000;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #fff;
    }

    .loader-circle {
      width: 70px;
      height: 70px;
      border: 6px solid rgba(255, 255, 255, 0.1);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
      margin-bottom: 24px;
    }

    .loader-text {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 12px;
      text-align: center;
    }

    .loader-subtext {
      font-size: 16px;
      color: #cbd5e1;
      font-family: monospace;
      background: rgba(0, 0, 0, 0.5);
      padding: 4px 12px;
      border-radius: 20px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ==================================================
       [3] MAGAZINE RENDER ENGINE
       ================================================== */
    .result-area {
      display: none;
      margin-top: 20px;
      padding-bottom: 60px;
      animation: slideUp 0.6s ease;
    }

    .mag-section {
      background: var(--bg-surface);
      border-radius: 20px;
      margin-bottom: 20px;
      border-left: 8px solid;
      overflow: hidden;
      box-shadow: var(--shadow-md);
      transition: transform 0.3s ease;
    }

    .mag-section:hover {
      transform: translateX(4px);
    }

    .mag-header {
      padding: 16px 20px;
      font-weight: 800;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .mag-body {
      padding: 20px;
      font-size: var(--mag-font-size);
      line-height: 1.8;
    }

    .mag-body ul {
      margin-left: 24px;
      margin-top: 12px;
      margin-bottom: 12px;
    }

    .mag-body li {
      margin-bottom: 8px;
    }

    /* Dynamic Colors */
    .color-1 {
      background-color: var(--mag-1-bg);
      border-left-color: var(--mag-1-border);
    }
    .color-2 {
      background-color: var(--mag-2-bg);
      border-left-color: var(--mag-2-border);
    }
    .color-3 {
      background-color: var(--mag-3-bg);
      border-left-color: var(--mag-3-border);
    }
    .color-4 {
      background-color: var(--mag-4-bg);
      border-left-color: var(--mag-4-border);
    }
    .color-5 {
      background-color: var(--mag-5-bg);
      border-left-color: var(--mag-5-border);
    }
    .color-6 {
      background-color: var(--mag-6-bg);
      border-left-color: var(--mag-6-border);
    }
    .color-7 {
      background-color: var(--mag-7-bg);
      border-left-color: var(--mag-7-border);
    }
    .color-8 {
      background-color: var(--mag-8-bg);
      border-left-color: var(--mag-8-border);
    }
    .color-9 {
      background-color: var(--mag-9-bg);
      border-left-color: var(--mag-9-border);
    }
    .color-10 {
      background-color: var(--mag-10-bg);
      border-left-color: var(--mag-10-border);
    }
    .color-11 {
      background-color: var(--mag-11-bg);
      border-left-color: var(--mag-11-border);
    }
    .color-12 {
      background-color: var(--mag-12-bg);
      border-left-color: var(--mag-12-border);
    }

    .arabic-text {
      font-family: 'Scheherazade New', 'Amiri', serif;
      font-size: 32px;
      line-height: 1.8;
      text-align: right;
      direction: rtl;
      padding: 20px;
      background: rgba(0, 0, 0, 0.04);
      border-radius: 12px;
      margin: 16px 0;
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    /* Action Bar */
    .action-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 32px;
      padding-top: 20px;
      border-top: 2px dashed var(--border-color);
    }

    .btn-outline {
      padding: 10px 20px;
      border: 2px solid var(--border-color);
      border-radius: 50px;
      background: var(--bg-surface);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-primary);
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-outline:hover {
      background: var(--accent-primary);
      color: #fff;
      border-color: var(--accent-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    /* ==================================================
       [4] MODALS & TOGGLES
       ================================================== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 500;
      display: none;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.show {
      opacity: 1;
    }

    .modal-content {
      background: var(--bg-surface);
      width: 92%;
      max-width: 500px;
      border-radius: 28px;
      padding: 32px;
      max-height: 85vh;
      overflow-y: auto;
      position: relative;
      transform: scale(0.9);
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    .modal-overlay.show .modal-content {
      transform: scale(1);
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      cursor: pointer;
      background: var(--bg-main);
      border-radius: 50%;
      padding: 8px;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: #ef4444;
      color: #fff;
      transform: rotate(90deg);
    }

    .form-group {
      margin-bottom: 20px;
      background: var(--bg-main);
      padding: 16px;
      border-radius: 16px;
      border: 1px solid var(--border-color);
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 12px;
      color: var(--text-primary);
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      background: var(--bg-surface);
      color: var(--text-primary);
      font-size: 15px;
      transition: border 0.3s;
      margin-bottom: 8px;
    }

    .form-input:focus {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(11, 94, 66, 0.1);
    }

    /* Toggle Switch */
    .toggle-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: var(--accent-primary);
    }

    input:checked+.slider:before {
      transform: translateX(22px);
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: -80px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-primary);
      color: var(--bg-surface);
      padding: 14px 28px;
      border-radius: 50px;
      transition: bottom 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      z-index: 2000;
      font-weight: bold;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toast.show {
      bottom: 32px;
    }

    /* ==================================================
       [5] NATIVE APP UI COMPONENTS (PWA)
       ================================================== */
    body {
      padding-bottom: 70px;
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* Bottom Navigation Bar (Mobile) */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 65px;
      background: var(--bg-surface);
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      z-index: 1000;
      border-top: 1px solid var(--border-color);
      padding-bottom: env(safe-area-inset-bottom, 0px);
      transition: background 0.3s;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: color 0.3s;
      flex: 1;
      padding: 8px 0;
    }

    .nav-item .material-symbols-rounded {
      font-size: 24px;
      margin-bottom: 4px;
      transition: transform 0.3s;
    }

    .nav-item.active {
      color: var(--accent-primary);
    }

    .nav-item.active .material-symbols-rounded {
      font-variation-settings: 'FILL' 1;
      transform: translateY(-2px);
    }

    /* Sidebar / Drawer */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      backdrop-filter: blur(2px);
    }

    .sidebar-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 280px;
      background: var(--bg-surface);
      z-index: 2000;
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-md);
      display: flex;
      flex-direction: column;
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .sb-header {
      padding: 24px;
      background: var(--accent-primary);
      color: #fff;
      display: flex;
      flex-direction: column;
      gap: 12px;
      border-bottom-right-radius: 20px;
      transition: background 0.3s;
    }

    .sb-content {
      padding: 16px;
      flex: 1;
      overflow-y: auto;
    }

    .sb-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 14px 16px;
      color: var(--text-primary);
      text-decoration: none;
      border-radius: 12px;
      font-weight: 600;
      margin-bottom: 8px;
      transition: background 0.3s, color 0.3s;
      cursor: pointer;
    }

    .sb-item:hover,
    .sb-item.active {
      background: var(--bg-main);
      color: var(--accent-primary);
    }

    .sb-item .material-symbols-rounded {
      color: var(--text-secondary);
      transition: color 0.3s;
    }

    .sb-item:hover .material-symbols-rounded,
    .sb-item.active .material-symbols-rounded {
      color: var(--accent-primary);
    }

    /* System panel inside sidebar */
    .system-panel {
      background: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 16px;
      margin-top: 20px;
      box-shadow: var(--shadow-sm);
      text-align: left;
    }

    .system-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .system-head h3 {
      font-size: 16px;
      color: var(--accent-primary);
    }

    .system-badges {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid transparent;
      background: var(--bg-main);
      color: var(--text-secondary);
    }

    .status-pill.ok {
      color: #0f766e;
      border-color: #99f6e4;
      background: #ccfbf1;
    }

    .status-pill.warn {
      color: #b45309;
      border-color: #fde68a;
      background: #fef3c7;
    }

    .status-pill.error {
      color: #b91c1c;
      border-color: #fecaca;
      background: #fee2e2;
    }

    [data-theme="dark"] .status-pill.ok {
      color: #99f6e4;
      border-color: #134e4a;
      background: #042f2e;
    }

    [data-theme="dark"] .status-pill.warn {
      color: #fde68a;
      border-color: #78350f;
      background: #451a03;
    }

    [data-theme="dark"] .status-pill.error {
      color: #fecaca;
      border-color: #7f1d1d;
      background: #450a0a;
    }

    .system-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .btn-mini {
      padding: 8px 12px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      background: var(--bg-main);
      color: var(--text-primary);
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .btn-mini:hover {
      border-color: var(--accent-primary);
      color: var(--accent-primary);
    }

    .system-msg {
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-secondary);
    }
  </style>
</head>

<body data-theme="light">

  <!-- Sidebar (Drawer on Mobile, Fixed on PC) -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="UI.toggleSidebar()"></div>
  <div class="sidebar" id="sidebar">
    <div class="sb-header">
      <div style="display: flex; align-items: center; gap: 12px;">
        <img src="logo.png" alt="Logo"
          style="width: 48px; height: 48px; border-radius: 12px; background: white; padding: 2px;">
        <div>
          <div style="font-size: 18px; font-weight: bold;">Islamic Hub</div>
          <div style="font-size: 12px; opacity: 0.9;">v4.0 Premium Edition</div>
        </div>
      </div>
    </div>
    <div class="sb-content no-scrollbar">
      <!-- Sidebar navigation items -->
      <div class="sb-item active" onclick="window.location.href='islamic.html'">
        <span class="material-symbols-rounded">home</span> ‡¶Æ‡ßÇ‡¶≤ ‡¶™‡¶æ‡¶§‡¶æ
      </div>
      <div class="sb-item" onclick="Logic.openQuranPage()">
        <span class="material-symbols-rounded">menu_book</span> ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶ì ‡¶π‡¶æ‡¶¶‡¶ø‡¶∏
      </div>
      <div class="sb-item" onclick="NamazModule.showNamazView(); UI.toggleSidebar();">
        <span class="material-symbols-rounded">self_improvement</span> ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ
      </div>
      <!-- New Q&A option -->
      <div class="sb-item" onclick="Logic.showHomeView(); UI.toggleSidebar();">
        <span class="material-symbols-rounded">help</span> ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßã‡¶§‡ßç‡¶§‡¶∞
      </div>
      <div class="sb-item" onclick="UI.openModal('historyModal'); UI.toggleSidebar();">
        <span class="material-symbols-rounded">history</span> ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶ì ‡¶¨‡ßÅ‡¶ï‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï
      </div>
      <div class="sb-item" onclick="UI.openModal('settingsModal'); UI.toggleSidebar();">
        <span class="material-symbols-rounded">settings</span> ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏
      </div>
      <div style="height: 1px; background: var(--border-color); margin: 16px 0;"></div>
      <div class="sb-item" onclick="UI.toggleTheme()">
        <span class="material-symbols-rounded" id="sbThemeIcon">dark_mode</span> ‡¶•‡¶ø‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®
      </div>

      <!-- AI/Offline Toggle moved to sidebar -->
      <div style="margin: 16px 0; padding: 12px; background: var(--bg-main); border-radius: 12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
          <span style="font-size:14px; font-weight:600;">‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶â‡¶§‡ßç‡¶§‡¶∞</span>
          <label class="switch">
            <input type="checkbox" id="aiToggle">
            <span class="slider"></span>
          </label>
          <span style="font-size:14px; font-weight:600;">‡¶è‡¶Ü‡¶á</span>
        </div>
        <div style="font-size:12px; color:var(--text-secondary);">‡¶è‡¶Ü‡¶á ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶™‡¶æ‡¶¨‡ßá‡¶®</div>
      </div>

      <!-- System Control Panel moved to sidebar -->
      <div class="system-panel" id="systemPanel">
        <div class="system-head">
          <h3>‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h3>
          <span id="sysLastSync" style="font-size:12px; color:var(--text-secondary);">‡¶∏‡¶ø‡¶ô‡ßç‡¶ï: -</span>
        </div>
        <div class="system-badges">
          <span id="sysOnlineBadge" class="status-pill">‡¶®‡ßá‡¶ü‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï: ‡¶ö‡ßá‡¶ï‡¶ø‡¶Ç</span>
          <span id="sysSwBadge" class="status-pill">‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶á‡¶û‡ßç‡¶ú‡¶ø‡¶®: ‡¶ö‡ßá‡¶ï‡¶ø‡¶Ç</span>
          <span id="sysInstallBadge" class="status-pill">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤: ‡¶ö‡ßá‡¶ï‡¶ø‡¶Ç</span>
          <span id="sysDataBadge" class="status-pill">‡¶°‡¶æ‡¶ü‡¶æ: ‡¶ö‡ßá‡¶ï‡¶ø‡¶Ç</span>
        </div>
        <div class="system-actions">
          <button class="btn-mini" onclick="SystemHub.syncNow()"><span class="material-symbols-rounded"
              style="font-size:16px;">sync</span> Sync Now</button>
          <button class="btn-mini" id="installAppBtn" onclick="SystemHub.installApp()"><span
              class="material-symbols-rounded" style="font-size:16px;">install_mobile</span> Install App</button>
          <button class="btn-mini" onclick="SystemHub.warmOffline()"><span class="material-symbols-rounded"
              style="font-size:16px;">download_for_offline</span> Offline Save</button>
          <button class="btn-mini" onclick="SystemHub.resumeLastActivity()"><span class="material-symbols-rounded"
              style="font-size:16px;">resume</span> Last Activity</button>
        </div>
        <div id="sysMessage" class="system-msg">‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation Bar (Mobile) -->
  <div class="bottom-nav">
    <div class="nav-item active" onclick="window.location.href='islamic.html'">
      <span class="material-symbols-rounded">home</span>
      <span>‡¶π‡ßã‡¶Æ</span>
    </div>
    <div class="nav-item" onclick="Logic.openQuranPage()">
      <span class="material-symbols-rounded">menu_book</span>
      <span>‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶®</span>
    </div>
    <div class="nav-item" onclick="NamazModule.showNamazView()">
      <span class="material-symbols-rounded">self_improvement</span>
      <span>‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú</span>
    </div>
    <div class="nav-item" onclick="UI.openModal('historyModal')">
      <span class="material-symbols-rounded">bookmark</span>
      <span>‡¶∏‡ßá‡¶≠‡¶°</span>
    </div>
    <div class="nav-item" onclick="UI.openModal('settingsModal')">
      <span class="material-symbols-rounded">settings</span>
      <span>‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</span>
    </div>
  </div>

  <div class="container">
    <!-- Header -->
    <header>
      <div class="logo">
        <button class="icon-btn menu-btn" onclick="UI.toggleSidebar()"
          style="padding: 4px; margin-right: 4px; margin-left: -8px;">
          <span class="material-symbols-rounded">menu</span>
        </button>
        <span class="material-symbols-rounded" style="color:var(--accent-primary);">mosque</span>
        <span style="font-size: 18px;">‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶ú‡ßç‡¶û‡¶æ‡¶®</span>
      </div>
      <div class="header-actions" style="display: flex; gap: 4px; align-items: center;">
        <button class="icon-btn" onclick="Logic.openQuranPage()" title="‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶ì ‡¶π‡¶æ‡¶¶‡¶ø‡¶∏ ‡¶≠‡¶æ‡¶£‡ßç‡¶°‡¶æ‡¶∞">
          <span class="material-symbols-rounded" style="color:var(--mag-3-border);">menu_book</span>
        </button>
        <button class="icon-btn" onclick="UI.toggleTheme()"><span class="material-symbols-rounded"
            id="themeIcon">dark_mode</span></button>
      </div>
    </header>

    <!-- Search & Vision Module (remaining on homepage) -->
    <div style="text-align: center; margin-bottom: 32px;">
      <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 15px; animation: slideDown 0.4s ease;">
        ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶¶‡¶≤‡¶ø‡¶≤‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶ú‡¶æ‡¶®‡ßÅ‡¶® (‡¶™‡ßç‡¶Ø‡¶æ‡¶∞‡¶æ‡¶≤‡¶æ‡¶≤ AI ‡¶á‡¶û‡ßç‡¶ú‡¶ø‡¶®)</p>

      <div class="search-wrapper">
        <input type="text" id="searchInput" class="search-input"
          placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶ì‡¶Ø‡ßÅ‡¶∞ ‡¶´‡¶∞‡¶ú ‡¶ï‡ßü‡¶ü‡¶ø?)..." autocomplete="off">
        <div id="visionIndicator" class="vision-indicator">üì∑ ‡¶õ‡¶¨‡¶ø ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§</div>
        <button class="icon-btn" onclick="document.getElementById('imageInput').click()" title="‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶°"><span
            class="material-symbols-rounded">add_a_photo</span></button>
        <input type="file" id="imageInput" accept="image/*" onchange="VisionProcessor.handleImage(event)">
        <button class="icon-btn" id="micBtn" onclick="AIEngine.startVoice()" title="‡¶≠‡ßü‡ßá‡¶∏ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü"><span
            class="material-symbols-rounded">mic</span></button>
        <button class="action-btn" onclick="Logic.handleSearch()"><span class="material-symbols-rounded">search</span>
          ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</button>
      </div>
    </div>

    <!-- Categories (Scrollable & Draggable) -->
    <div class="cat-scroll-container">
      <div class="cat-scroll" id="catContainer"></div>
    </div>

    <!-- Question Grid -->
    <div class="grid" id="qContainer"></div>

    <!-- Namaz Shikkha Area -->
    <div class="result-area" id="namazArea" style="display: none; padding-top: 16px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <button class="btn-outline"
          style="display: inline-flex; width: auto; padding: 6px 16px; border-color: var(--accent-primary);"
          onclick="Logic.goBack()">
          <span class="material-symbols-rounded">arrow_back</span> ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®
        </button>
        <span
          style="font-size: 20px; font-weight: 800; color: var(--accent-primary); display:flex; align-items:center; gap:8px;">
          <span class="material-symbols-rounded">mosque</span> ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ
        </span>
      </div>

      <!-- List of Prayers Grid -->
      <div class="grid" id="namazListContainer"></div>

      <!-- Individual Prayer Details -->
      <div id="namazDetailContainer" style="display: none;"></div>
    </div>

    <!-- Results Area (Magazine Render) -->
    <div class="result-area" id="resultArea">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <button class="btn-outline"
          style="display: inline-flex; width: auto; padding: 6px 16px; border-color: var(--accent-primary);"
          onclick="Logic.goBack()">
          <span class="material-symbols-rounded">arrow_back</span> ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®
        </button>
        <div
          style="display: flex; gap: 8px; background: var(--bg-surface); padding: 4px 12px; border-radius: 50px; border: 1px solid var(--border-color);">
          <span
            style="font-size: 13px; font-weight: bold; margin-right: 4px; display: flex; align-items: center;">‡¶´‡¶®‡ßç‡¶ü:</span>
          <button class="icon-btn" style="padding: 4px;" onclick="UI.changeFontSize(-1)" title="‡¶õ‡ßã‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®"><span
              class="material-symbols-rounded" style="font-size: 20px;">text_decrease</span></button>
          <button class="icon-btn" style="padding: 4px;" onclick="UI.changeFontSize(1)" title="‡¶¨‡ßú ‡¶ï‡¶∞‡ßÅ‡¶®"><span
              class="material-symbols-rounded" style="font-size: 20px;">text_increase</span></button>
        </div>
      </div>
      <div
        style="font-size: 26px; font-weight: 800; margin-bottom: 24px; color: var(--accent-primary); line-height: 1.4;"
        id="resQuestionTitle"></div>
      <div id="magazineContent"></div>

      <!-- Smart Suggestions -->
      <div
        style="margin-top: 32px; background: var(--bg-surface); padding: 20px; border-radius: 20px; border: 1px solid var(--border-color);">
        <h3
          style="font-size: 16px; color: var(--text-secondary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
          <span class="material-symbols-rounded">lightbulb</span> ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡¶ø‡¶§ ‡¶Ü‡¶∞‡ßã ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®:
        </h3>
        <div id="suggestionChips" class="suggestion-grid"></div>
      </div>

      <!-- Action Bar -->
      <div class="action-bar" style="display:flex; flex-wrap:wrap; gap:8px;">
        <button class="btn-outline" onclick="Logic.copyAns()"><span class="material-symbols-rounded">content_copy</span>
          ‡¶ï‡¶™‡¶ø</button>
        <button class="btn-outline" onclick="Logic.shareAns()"><span class="material-symbols-rounded">share</span>
          ‡¶∂‡ßá‡ßü‡¶æ‡¶∞</button>
        <button class="btn-outline" onclick="Logic.downloadAns()"><span class="material-symbols-rounded">download</span>
          ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
        <button class="btn-outline" id="speakBtn" onclick="Logic.speakAns()"><span
            class="material-symbols-rounded">volume_up</span> ‡¶∂‡ßÅ‡¶®‡ßÅ‡¶®</button>
        <button class="btn-outline" onclick="Logic.saveBookmark()"><span
            class="material-symbols-rounded">bookmark_add</span> ‡¶∏‡ßá‡¶≠</button>
        <button class="btn-outline" id="expandOfflineBtn" onclick="Logic.expandOfflineAnswer()"
          style="display:none; border-color:#2563eb; color:#2563eb;"><span
            class="material-symbols-rounded">smart_toy</span> AI ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</button>
        <button class="btn-outline" id="verifyBtn" onclick="Logic.verifyAns()"
          style="border-color: var(--mag-6-border); color: var(--mag-6-border);"><span
            class="material-symbols-rounded">verified</span> ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á</button>

        <!-- Font Size Controls -->
        <div
          style="display:flex; align-items:center; background:var(--bg-main); border-radius:20px; padding:2px 4px; margin-left:auto;">
          <button class="icon-btn" onclick="Logic.changeFontSize(-1)" style="padding:4px;" title="‡¶´‡¶®‡ßç‡¶ü ‡¶õ‡ßã‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®"><span
              class="material-symbols-rounded" style="font-size:18px;">text_decrease</span></button>
          <button class="icon-btn" onclick="Logic.changeFontSize(1)" style="padding:4px;" title="‡¶´‡¶®‡ßç‡¶ü ‡¶¨‡ßú ‡¶ï‡¶∞‡ßÅ‡¶®"><span
              class="material-symbols-rounded" style="font-size:18px;">text_increase</span></button>
        </div>

        <span
          style="font-size: 13px; color: var(--text-secondary); align-self: center; background: var(--bg-main); padding: 4px 10px; border-radius: 20px;"
          id="aiStats"></span>
      </div>
    </div>
  </div>

  <!-- Loader -->
  <div class="loader-overlay" id="loader">
    <div class="loader-circle"></div>
    <div class="loader-text" id="loaderText">‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...</div>
    <div class="loader-subtext" id="loaderSubText">0.0s</div>
    <div id="loaderQuote"
      style="margin-top: 24px; font-size: 15px; color: #a7f3d0; font-style: italic; text-align: center; max-width: 80%; line-height: 1.5; font-weight: 500;">
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal-content">
      <button class="modal-close" onclick="UI.closeModal('settingsModal')"><span
          class="material-symbols-rounded">close</span></button>
      <h2 style="margin-bottom: 24px; display: flex; align-items: center; gap: 8px;"><span
          class="material-symbols-rounded">tune</span> ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶ì API</h2>

      <!-- Parallel Execution Toggle (still in settings) -->
      <div class="form-group toggle-container">
        <div>
          <label style="margin-bottom: 4px;">‡¶™‡ßç‡¶Ø‡¶æ‡¶∞‡¶æ‡¶≤‡¶æ‡¶≤ ‡¶è‡¶ï‡ßç‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶∂‡¶® (Parallel Mode)</label>
          <span style="font-size: 12px; color: var(--text-secondary);">‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡ß©‡¶ü‡¶ø API ‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá ‡¶ï‡¶≤ ‡¶π‡¶¨‡ßá, ‡¶Ø‡ßá‡¶ü‡¶ø ‡¶Ü‡¶ó‡ßá ‡¶â‡¶§‡ßç‡¶§‡¶∞
            ‡¶¶‡ßá‡¶¨‡ßá ‡¶∏‡ßá‡¶ü‡¶ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá‡•§ ‡¶¨‡¶®‡ßç‡¶ß ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤‡¶ø ‡¶ü‡ßç‡¶∞‡¶æ‡¶á ‡¶ï‡¶∞‡¶¨‡ßá‡•§</span>
        </div>
        <label class="switch">
          <input type="checkbox" id="parallelToggle">
          <span class="slider"></span>
        </label>
      </div>

      <div class="form-group">
        <label>Google Gemini (Primary)</label>
        <input type="password" id="geminiKey" class="form-input" placeholder="API Key (AIzaSy...)">
        <input type="text" id="geminiModel" class="form-input" value="gemini-1.5-flash" placeholder="Model Name">
      </div>
      <div class="form-group">
        <label>OpenRouter (Fallback 1)</label>
        <input type="password" id="orKey" class="form-input" placeholder="API Key (sk-or-v1-...)">
        <input type="text" id="orModel" class="form-input" value="deepseek/deepseek-chat" placeholder="Model Name">
      </div>
      <div class="form-group">
        <label>Grok / xAI (Fallback 2)</label>
        <input type="password" id="grokKey" class="form-input" placeholder="API Key (xai-...)">
        <input type="text" id="grokModel" class="form-input" value="grok-1" placeholder="Model Name">
      </div>
      <div style="display: flex; gap: 12px; margin-top: 12px;">
        <button class="btn-outline" style="flex: 1; justify-content: center; color: #ef4444; border-color: #ef4444;"
          onclick="StorageEngine.clearCache()">‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
        <button class="action-btn" style="flex: 2; justify-content: center; font-size: 16px; padding: 14px;"
          onclick="StorageEngine.saveSettings()">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div class="modal-overlay" id="historyModal">
    <div class="modal-content">
      <button class="modal-close" onclick="UI.closeModal('historyModal')"><span
          class="material-symbols-rounded">close</span></button>
      <h2 style="margin-bottom: 24px;">‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶ì ‡¶¨‡ßÅ‡¶ï‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï</h2>
      <div style="display: flex; gap: 12px; margin-bottom: 20px;">
        <button class="btn-outline" style="flex:1; justify-content:center;"
          onclick="UI.renderHistory('history')">‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</button>
        <button class="btn-outline" style="flex:1; justify-content:center;"
          onclick="UI.renderHistory('bookmark')">‡¶¨‡ßÅ‡¶ï‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï</button>
      </div>
      <div id="historyList" style="max-height: 400px; overflow-y: auto; padding-right: 8px;"></div>
    </div>
  </div>

  <div class="modal-overlay" id="fileViewerModal">
    <div class="modal-content" style="max-width: 760px;">
      <button class="modal-close" onclick="UI.closeModal('fileViewerModal')"><span
          class="material-symbols-rounded">close</span></button>
      <h2 id="fileViewerTitle" style="margin-bottom: 16px;">‡¶´‡¶æ‡¶á‡¶≤ ‡¶≠‡¶ø‡¶â</h2>
      <pre id="fileViewerBody" class="json-viewer">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</pre>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"><span class="material-symbols-rounded">info</span> <span id="toastMsg">‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ</span>
  </div>

  <script src="quran-module.js"></script>
  <script>
    /**
     * ==================================================
     * ISLAMIC KNOWLEDGE HUB - ARCHITECTURE JS (v4.0)
     * ==================================================
     */

    // ==========================================
    // 1. DATA MODULE (Strict 800+ Questions)
    // ==========================================
    const DataModule = (function () {
      const mod = {
        categories: [],
        questions: [],
        questionMap: {},
        lastLoadedAt: null,
        loadData: async () => {
          const safeLoadJson = async (file) => {
            try {
              const res = await fetch(file);
              if (!res.ok) throw new Error(`${file} not found`);
              return await res.json();
            } catch (err) {
              console.warn(`Failed to load ${file}`, err);
              return null;
            }
          };

          const toCatId = (id) => String(id || 'general').toLowerCase().replace(/[^\w\u0980-\u09FF]+/g, '_');
          const categoryIndex = new Map();
          const questionIndex = new Map();

          const addCategory = (id, cat = {}) => {
            const catId = toCatId(id);
            if (!categoryIndex.has(catId)) {
              const newCat = {
                id: catId,
                name: cat.name || id,
                icon: cat.icon || 'help',
                color: cat.color || '#10b981'
              };
              categoryIndex.set(catId, newCat);
              mod.categories.push(newCat);
            }
            return categoryIndex.get(catId);
          };

          const addQuestion = (catId, qObj) => {
            const qText = typeof qObj === 'string' ? qObj : qObj && qObj.q;
            if (!qText || !qText.trim()) return;
            const key = qText.trim();

            if (questionIndex.has(key)) {
              const existing = questionIndex.get(key);
              if (!existing.a && qObj && typeof qObj !== 'string' && qObj.a) existing.a = qObj.a;
              if (!existing.ref && qObj && typeof qObj !== 'string' && qObj.ref) existing.ref = qObj.ref;
              return;
            }

            const obj = {
              q: key,
              c: catId,
              a: typeof qObj === 'string' ? null : (qObj.a || null),
              ref: typeof qObj === 'string' ? null : (qObj.ref || null)
            };
            mod.questions.push(obj);
            mod.questionMap[key] = obj;
            questionIndex.set(key, obj);
          };

          const ingestCategorySource = (src) => {
            if (!src || typeof src !== 'object') return;
            Object.keys(src).forEach(key => {
              const cat = src[key];
              if (!cat || typeof cat !== 'object' || !Array.isArray(cat.questions)) return;
              const added = addCategory(key, cat);
              cat.questions.forEach(qObj => addQuestion(added.id, qObj));
            });
          };

          try {
            const [ansData, namazData, questionData] = await Promise.all([
              safeLoadJson('ans.json'),
              safeLoadJson('namazshikkha.json'),
              safeLoadJson('question.json')
            ]);

            window.IslamicData = ansData || {};
            window.NamazData = namazData || null;
            window.QuestionData = questionData || {};

            mod.categories = [];
            mod.questions = [];
            mod.questionMap = {};

            addCategory('all', { name: '‡¶∏‡¶¨', icon: 'apps', color: '#6366f1' });
            ingestCategorySource(ansData);
            ingestCategorySource(questionData);
            mod.lastLoadedAt = Date.now();

            if (mod.categories.length <= 1) {
              UIEngine.showToast("‡¶°‡ßá‡¶ü‡¶æ ‡¶Ü‡¶Ç‡¶∂‡¶ø‡¶ï ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶ï‡¶®‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§ ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§");
            }
            if (window.SystemHub && typeof window.SystemHub.refreshStatus === 'function') {
              window.SystemHub.refreshStatus();
            }
          } catch (e) {
            console.error("Unified data load failed", e);
            UIEngine.showToast("‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶°‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
          }
        }
      };
      return mod;
    })();

    const DIGIT_MAP = { '‡ß¶': '0', '‡ßß': '1', '‡ß®': '2', '‡ß©': '3', '‡ß™': '4', '‡ß´': '5', '‡ß¨': '6', '‡ß≠': '7', '‡ßÆ': '8', '‡ßØ': '9' };
    const toEnglishDigits = (value) => String(value || '').replace(/[‡ß¶-‡ßØ]/g, d => DIGIT_MAP[d] || d);

    function checkOfflineStatus() {
      const isOnline = navigator.onLine;
      const msg = isOnline ? "‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü" : "‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶Æ‡ßã‡¶° ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü";
      console.log(msg);
      return isOnline;
    }

    const AudioManager = {
      currentAudio: null,
      currentBlobUrl: null,
      cacheName: 'islamic-audio-cache-v1',

      getSurahId: (name) => {
        const normalized = toEnglishDigits(String(name || '')).toLowerCase().replace(/\s+/g, ' ').trim();
        const direct = normalized.match(/\d+/);
        if (direct) {
          const id = parseInt(direct[0], 10);
          if (id >= 1 && id <= 114) return id;
        }
        const map = [
          { regex: /\b(‡¶´‡¶æ‡¶§‡¶ø‡¶π‡¶æ|fatiha)\b/i, id: 1 },
          { regex: /\b(‡¶¨‡¶æ‡¶ï‡¶æ‡¶∞‡¶æ|‡¶¨‡¶æ‡¶ï‡ßç‡¶¨‡¶æ‡¶∞‡¶æ|baqarah|bakara)\b/i, id: 2 },
          { regex: /\b(‡¶á‡¶Æ‡¶∞‡¶æ‡¶®|imran)\b/i, id: 3 },
          { regex: /\b(‡¶®‡¶ø‡¶∏‡¶æ|nisa)\b/i, id: 4 },
          { regex: /\b(‡¶Æ‡¶æ‡ßü‡ßá‡¶¶‡¶æ|maida)\b/i, id: 5 },
          { regex: /\b(‡¶Ü‡¶®‡¶Ü‡¶Æ|anam)\b/i, id: 6 },
          { regex: /\b(‡¶Ü‡¶∞‡¶æ‡¶´|araf)\b/i, id: 7 },
          { regex: /\b(‡¶Ü‡¶®‡¶´‡¶æ‡¶≤|anfal)\b/i, id: 8 },
          { regex: /\b(‡¶§‡¶ì‡¶¨‡¶æ|‡¶§‡¶æ‡¶ì‡¶¨‡¶æ|tawbah|tauba)\b/i, id: 9 },
          { regex: /\b(‡¶á‡¶â‡¶®‡ßÅ‡¶∏|yunus)\b/i, id: 10 },
          { regex: /\b(‡¶á‡¶â‡¶∏‡ßÅ‡¶´|yusuf)\b/i, id: 12 },
          { regex: /\b(‡¶á‡¶¨‡ßç‡¶∞‡¶æ‡¶π‡¶ø‡¶Æ|‡¶á‡¶¨‡ßç‡¶∞‡¶æ‡¶π‡ßÄ‡¶Æ|ibrahim)\b/i, id: 14 },
          { regex: /\b(‡¶ï‡¶æ‡¶π‡¶´|kahf)\b/i, id: 18 },
          { regex: /\b(‡¶Æ‡¶æ‡¶∞‡¶á‡ßü‡¶æ‡¶Æ|maryam)\b/i, id: 19 },
          { regex: /\b(‡¶á‡ßü‡¶æ‡¶∏‡¶ø‡¶®|yasin|Ÿäÿ≥)\b/i, id: 36 },
          { regex: /\b(‡¶∞‡¶π‡¶Æ‡¶æ‡¶®|rahman)\b/i, id: 55 },
          { regex: /\b(‡¶ì‡ßü‡¶æ‡¶ï‡¶ø‡ßü‡¶æ|waqiah)\b/i, id: 56 },
          { regex: /\b(‡¶Æ‡ßÅ‡¶≤‡¶ï|mulk)\b/i, id: 67 },
          { regex: /\b(‡¶á‡¶®‡¶∏‡¶æ‡¶®|insan)\b/i, id: 76 },
          { regex: /\b(‡¶®‡¶æ‡¶¨‡¶æ|naba)\b/i, id: 78 },
          { regex: /\b(‡¶§‡¶æ‡¶ï‡¶æ‡¶∏‡ßÅ‡¶∞|takasur)\b/i, id: 102 },
          { regex: /\b(‡¶á‡¶ñ‡¶≤‡¶æ‡¶∏|ikhlas)\b/i, id: 112 },
          { regex: /\b(‡¶´‡¶æ‡¶≤‡¶æ‡¶ï|falaq)\b/i, id: 113 },
          { regex: /\b(‡¶®‡¶æ‡¶∏|nas)\b/i, id: 114 }
        ];
        for (let entry of map) {
          if (entry.regex.test(normalized)) return entry.id;
        }
        return 1; // default
      },

      getCacheKey: (surahId, ayah) => `offline-audio://${surahId}:${ayah}`,

      resolveAudioUrl: async (surahId, ayah) => {
        if (window.IslamicModule && IslamicModule.Quran && IslamicModule.Quran.getAyah) {
          const data = await IslamicModule.Quran.getAyah(surahId, ayah);
          if (data && data.audio) return data.audio;
        }
        try {
          const apiRes = await fetch(`https://api.alquran.cloud/v1/ayah/${surahId}:${ayah}/ar.alafasy`);
          if (apiRes.ok) {
            const parsed = await apiRes.json();
            if (parsed && parsed.data && parsed.data.audio) return parsed.data.audio;
          }
        } catch (e) { }
        return `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${surahId * 1000 + parseInt(ayah, 10)}.mp3`;
      },

      getCachedResponse: async (surahId, ayah) => {
        const cache = await caches.open(AudioManager.cacheName);
        const key = AudioManager.getCacheKey(surahId, ayah);
        return await cache.match(key);
      },

      setStatus: (statusId, text, isError = false) => {
        if (!statusId) return;
        const el = document.getElementById(statusId);
        if (!el) return;
        el.innerText = text;
        el.style.color = isError ? '#dc2626' : 'var(--text-secondary)';
      },

      play: async (surahName, ayah, statusId) => {
        const surahId = AudioManager.getSurahId(surahName);
        const ayahNo = parseInt(toEnglishDigits(ayah), 10);
        if (!ayahNo || ayahNo < 1) {
          UIEngine.showToast("‡¶Ü‡ßü‡¶æ‡¶§ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü‡•§");
          return;
        }

        if (AudioManager.currentAudio) AudioManager.currentAudio.pause();
        if (AudioManager.currentBlobUrl) {
          URL.revokeObjectURL(AudioManager.currentBlobUrl);
          AudioManager.currentBlobUrl = null;
        }

        try {
          const cached = await AudioManager.getCachedResponse(surahId, ayahNo);
          if (cached) {
            const blob = await cached.blob();
            const blobUrl = URL.createObjectURL(blob);
            AudioManager.currentBlobUrl = blobUrl;
            AudioManager.currentAudio = new Audio(blobUrl);
            await AudioManager.currentAudio.play();
            AudioManager.setStatus(statusId, "‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßç‡¶≤‡ßá ‡¶π‡¶ö‡ßç‡¶õ‡ßá");
            return;
          }

          if (!navigator.onLine) {
            AudioManager.setStatus(statusId, "‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®: ‡¶Ü‡¶ó‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á", true);
            UIEngine.showToast("‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶™‡ßç‡¶≤‡ßá ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ü‡¶ó‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            return;
          }

          const url = await AudioManager.resolveAudioUrl(surahId, ayahNo);
          AudioManager.currentAudio = new Audio(url);
          await AudioManager.currentAudio.play();
          AudioManager.setStatus(statusId, "‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶™‡ßç‡¶≤‡ßá ‡¶π‡¶ö‡ßç‡¶õ‡ßá");
        } catch (err) {
          console.error(err);
          AudioManager.setStatus(statusId, "‡¶Ö‡¶°‡¶ø‡¶ì ‡¶ö‡¶æ‡¶≤‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø", true);
          UIEngine.showToast("‡¶Ö‡¶°‡¶ø‡¶ì ‡¶ö‡¶æ‡¶≤‡¶æ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
        }
      },

      download: async (surahName, ayah, btnId, statusId) => {
        const btn = document.getElementById(btnId);
        const surahId = AudioManager.getSurahId(surahName);
        const ayahNo = parseInt(toEnglishDigits(ayah), 10);
        if (!ayahNo || ayahNo < 1) return;

        try {
          if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-rounded">hourglass_top</span> ‡¶®‡¶æ‡¶Æ‡¶õ‡ßá...';
          }
          if (!navigator.onLine) throw new Error("offline");

          const url = await AudioManager.resolveAudioUrl(surahId, ayahNo);
          const res = await fetch(url);
          if (!res.ok) throw new Error("fetch-failed");

          const cache = await caches.open(AudioManager.cacheName);
          const key = AudioManager.getCacheKey(surahId, ayahNo);
          await cache.put(key, res.clone());

          if (btn) btn.innerHTML = '<span class="material-symbols-rounded">task_alt</span> ‡¶∏‡ßá‡¶≠‡¶°';
          AudioManager.setStatus(statusId, "‡¶Ö‡¶°‡¶ø‡¶ì ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá, ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®‡ßá‡¶ì ‡¶ö‡¶≤‡¶¨‡ßá");
          UIEngine.showToast("‡¶Ö‡¶°‡¶ø‡¶ì ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
        } catch (error) {
          console.error(error);
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<span class="material-symbols-rounded">download_for_offline</span> ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®';
          }
          AudioManager.setStatus(statusId, "‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡ßü‡¶®‡¶ø", true);
          UIEngine.showToast("‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        }
      }
    };

    const ContentEnricher = {
      parse: (text) => {
        if (!text) return "";

        const escJs = (value) => String(value || '')
          .replace(/\\/g, '\\\\')
          .replace(/'/g, "\\'")
          .replace(/\r?\n/g, ' ')
          .replace(/\s+/g, ' ')
          .trim();

        let enriched = text;

        const quranRegex = /(‡¶∏‡ßÇ‡¶∞‡¶æ|‡¶∏‡ßÅ‡¶∞‡¶æ|Surah)\s+([^\n:‡•§,.]{1,40}?)(?:\s*[:‡¶É]\s*|\s+(?:‡¶Ü‡ßü‡¶æ‡¶§|‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§|verse)\s*)([0-9‡ß¶-‡ßØ]{1,3})/gi;
        enriched = enriched.replace(quranRegex, (match, _, surahName, ayahRaw) => {
          const ayahNo = parseInt(toEnglishDigits(ayahRaw), 10);
          if (!ayahNo || ayahNo < 1) return match;

          const cleanSurah = String(surahName || '').trim();
          const safeSurah = escJs(cleanSurah);
          const uidBase = `${cleanSurah}-${ayahNo}-${Math.random().toString(36).slice(2, 7)}`.replace(/[^\w\u0980-\u09FF-]/g, '_');
          const btnId = `dl-${uidBase}`;
          const statusId = `status-${uidBase}`;

          return `
          <div class="ref-audio-card">
            <div class="ref-header">
              <span class="material-symbols-rounded">menu_book</span>
              <strong>${match}</strong>
            </div>
            <div class="ref-controls">
              <button class="btn-play" onclick="AudioManager.play('${safeSurah}', ${ayahNo}, '${statusId}')">
                <span class="material-symbols-rounded">play_circle</span> ‡¶∂‡ßÅ‡¶®‡ßÅ‡¶®
              </button>
              <button class="btn-download" id="${btnId}" onclick="AudioManager.download('${safeSurah}', ${ayahNo}, '${btnId}', '${statusId}')">
                <span class="material-symbols-rounded">download_for_offline</span> ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
              </button>
            </div>
            <div id="${statusId}" class="status-text"></div>
          </div>`;
        });

        const hadithRegex = /((?:‡¶∏‡¶π‡ßÄ‡¶π\s*)?(?:‡¶¨‡ßÅ‡¶ñ‡¶æ‡¶∞[‡ßÄ‡¶ø]|‡¶Æ‡ßÅ‡¶∏‡¶≤‡¶ø‡¶Æ|‡¶§‡¶ø‡¶∞‡¶Æ‡¶ø[‡¶ú‡¶ø‡¶Ø‡ßÄ]|‡¶Ü‡¶¨‡ßÅ\s*‡¶¶‡¶æ‡¶â‡¶¶|‡¶®‡¶æ‡¶∏‡¶æ‡¶à|‡¶á‡¶¨‡¶®‡ßá\s*‡¶Æ‡¶æ‡¶ú‡¶æ‡¶π|‡¶Æ‡ßÅ‡¶Ø‡¶º‡¶æ‡¶§‡ßç‡¶§‡¶æ|‡¶Æ‡ßÅ‡ßü‡¶æ‡¶§‡ßç‡¶§‡¶æ|‡¶Æ‡ßÅ‡¶∏‡¶®‡¶æ‡¶¶\s*‡¶Ü‡¶π‡¶Æ‡¶¶)\s*[:Ôºö]?\s*[0-9‡ß¶-‡ßØ]{1,5})/gi;
        enriched = enriched.replace(hadithRegex, (match) => {
          const parts = match.match(/((?:‡¶∏‡¶π‡ßÄ‡¶π\s*)?(?:‡¶¨‡ßÅ‡¶ñ‡¶æ‡¶∞[‡ßÄ‡¶ø]|‡¶Æ‡ßÅ‡¶∏‡¶≤‡¶ø‡¶Æ|‡¶§‡¶ø‡¶∞‡¶Æ‡¶ø[‡¶ú‡¶ø‡¶Ø‡ßÄ]|‡¶Ü‡¶¨‡ßÅ\s*‡¶¶‡¶æ‡¶â‡¶¶|‡¶®‡¶æ‡¶∏‡¶æ‡¶à|‡¶á‡¶¨‡¶®‡ßá\s*‡¶Æ‡¶æ‡¶ú‡¶æ‡¶π|‡¶Æ‡ßÅ‡¶Ø‡¶º‡¶æ‡¶§‡ßç‡¶§‡¶æ|‡¶Æ‡ßÅ‡ßü‡¶æ‡¶§‡ßç‡¶§‡¶æ|‡¶Æ‡ßÅ‡¶∏‡¶®‡¶æ‡¶¶\s*‡¶Ü‡¶π‡¶Æ‡¶¶))\s*[:Ôºö]?\s*([0-9‡ß¶-‡ßØ]{1,5})/i);
          if (!parts) return match;
          const book = parts[1].trim();
          const number = toEnglishDigits(parts[2]);
          const uidBase = `hadith-${book}-${number}-${Math.random().toString(36).slice(2, 7)}`.replace(/[^\w\u0980-\u09FF-]/g, '_');
          const statusId = `status-${uidBase}`;
          const safeBook = escJs(book);
          const safeNumber = escJs(number);

          return `
          <div class="ref-audio-card hadith-ref-card">
            <div class="ref-header">
              <span class="material-symbols-rounded">library_books</span>
              <strong>${match}</strong>
            </div>
            <div class="ref-controls">
              <button class="btn-play" onclick="HadithVerifier.verify('${safeBook}', '${safeNumber}', '${statusId}')">
                <span class="material-symbols-rounded">verified</span> ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏ ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á
              </button>
            </div>
            <div id="${statusId}" class="status-text"></div>
          </div>`;
        });

        const arabicBlockRegex = /<div class="arabic-text">([\s\S]*?)<\/div>/gi;
        enriched = enriched.replace(arabicBlockRegex, (_, arabicHtml) => {
          const plainArabic = String(arabicHtml || '').replace(/<[^>]+>/g, ' ').replace(/&nbsp;/g, ' ').replace(/\s+/g, ' ').trim();
          if (!plainArabic) return `<div class="arabic-text">${arabicHtml}</div>`;
          const uidBase = `arabic-${Math.random().toString(36).slice(2, 8)}`;
          const statusId = `status-${uidBase}`;
          const safeArabic = escJs(plainArabic);
          return `
          <div class="ref-audio-card arabic-ref-card">
            <div class="ref-header">
              <span class="material-symbols-rounded">translate</span>
              <strong>‡¶Ü‡¶∞‡¶¨‡¶ø ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü</strong>
            </div>
            <div class="arabic-text" dir="rtl">${arabicHtml}</div>
            <div class="ref-controls">
              <button class="btn-play" onclick="ArabicAssist.play('${safeArabic}', '${statusId}')">
                <span class="material-symbols-rounded">volume_up</span> ‡¶Ü‡¶∞‡¶¨‡¶ø ‡¶∂‡ßÅ‡¶®‡ßÅ‡¶®
              </button>
              <button class="btn-download" onclick="ArabicAssist.pronounce('${safeArabic}', '${statusId}')">
                <span class="material-symbols-rounded">record_voice_over</span> ‡¶â‡¶ö‡ßç‡¶ö‡¶æ‡¶∞‡¶£
              </button>
            </div>
            <div id="${statusId}" class="status-text"></div>
          </div>`;
        });

        return enriched;
      },

      injectStyles: () => {
        if (document.getElementById('content-enricher-style')) return;
        const style = document.createElement('style');
        style.id = 'content-enricher-style';
        style.innerHTML = `
          .ref-audio-card {
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--accent-primary);
            border-radius: 12px;
            padding: 12px;
            margin: 12px 0;
            background: var(--bg-surface);
          }
          .hadith-ref-card { border-left-color: #f59e0b; }
          .arabic-ref-card { border-left-color: #7c3aed; }
          .ref-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            color: var(--text-primary);
          }
          .ref-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
          }
          .btn-play,
          .btn-download {
            border: 1px solid var(--border-color);
            border-radius: 999px;
            padding: 6px 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            background: var(--bg-main);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 13px;
          }
          .btn-download {
            background: #e0f2fe;
            color: #0284c7;
            border-color: #bae6fd;
          }
          .status-text {
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.55;
          }
        `;
        document.head.appendChild(style);
      }
    };

    const ReferenceTools = {
      findHadithRefs: (text) => {
        const source = String(text || '');
        const regex = /(?:‡¶∏‡¶π‡ßÄ‡¶π\s*)?(‡¶¨‡ßÅ‡¶ñ‡¶æ‡¶∞[‡ßÄ‡¶ø]|‡¶Æ‡ßÅ‡¶∏‡¶≤‡¶ø‡¶Æ|‡¶§‡¶ø‡¶∞‡¶Æ‡¶ø[‡¶ú‡¶ø‡¶Ø‡ßÄ]|‡¶Ü‡¶¨‡ßÅ\s*‡¶¶‡¶æ‡¶â‡¶¶|‡¶®‡¶æ‡¶∏‡¶æ‡¶à|‡¶á‡¶¨‡¶®‡ßá\s*‡¶Æ‡¶æ‡¶ú‡¶æ‡¶π|‡¶Æ‡ßÅ‡¶Ø‡¶º‡¶æ‡¶§‡ßç‡¶§‡¶æ|‡¶Æ‡ßÅ‡ßü‡¶æ‡¶§‡ßç‡¶§‡¶æ|‡¶Æ‡ßÅ‡¶∏‡¶®‡¶æ‡¶¶\s*‡¶Ü‡¶π‡¶Æ‡¶¶)\s*[:Ôºö]?\s*([0-9‡ß¶-‡ßØ]{1,5})/gi;
        const rows = [];
        let match;
        while ((match = regex.exec(source)) !== null) {
          const book = String(match[1] || '').trim();
          const number = toEnglishDigits(match[2]);
          const key = `${book}|${number}`;
          if (!rows.find(x => `${x.book}|${x.number}` === key)) {
            rows.push({ book, number });
          }
        }
        return rows;
      },

      findQuranRefs: (text) => {
        const source = String(text || '');
        const regex = /(‡¶∏‡ßÇ‡¶∞‡¶æ|‡¶∏‡ßÅ‡¶∞‡¶æ|Surah)\s+([^\n:‡•§,.]{1,40}?)(?:\s*[:‡¶É]\s*|\s+(?:‡¶Ü‡ßü‡¶æ‡¶§|‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§|verse)\s*)([0-9‡ß¶-‡ßØ]{1,3})/gi;
        const rows = [];
        let match;
        while ((match = regex.exec(source)) !== null) {
          const surah = String(match[2] || '').trim();
          const ayah = toEnglishDigits(match[3]);
          const key = `${surah}|${ayah}`;
          if (!rows.find(x => `${x.surah}|${x.ayah}` === key)) {
            rows.push({ surah, ayah });
          }
        }
        return rows;
      },

      extractLines: (text, explicitRef) => {
        const lines = [];
        const source = String(text || '');
        const refs = source.match(/(?:‡¶§‡¶•‡ßç‡¶Ø‡¶∏‡ßÇ‡¶§‡ßç‡¶∞|‡¶∏‡ßÇ‡¶§‡ßç‡¶∞|‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏)\s*[:Ôºö]\s*([^\n<]+)/gi) || [];
        refs.forEach(line => lines.push(line.replace(/\*\*/g, '').trim()));
        if (explicitRef) lines.push(`‡¶§‡¶•‡ßç‡¶Ø‡¶∏‡ßÇ‡¶§‡ßç‡¶∞: ${String(explicitRef).trim()}`);

        ReferenceTools.findHadithRefs(source).forEach(item => {
          lines.push(`${item.book} ${item.number}`);
        });
        ReferenceTools.findQuranRefs(source).forEach(item => {
          lines.push(`‡¶∏‡ßÇ‡¶∞‡¶æ ${item.surah}: ${item.ayah}`);
        });

        return [...new Set(lines.filter(Boolean))];
      }
    };

    const HadithVerifier = {
      normalizeBook: (book) => {
        const key = String(book || '').replace(/\s+/g, '').toLowerCase();
        if (key.includes('‡¶¨‡ßÅ‡¶ñ‡¶æ‡¶∞')) return 'bukhari';
        if (key.includes('‡¶Æ‡ßÅ‡¶∏‡¶≤‡¶ø‡¶Æ')) return 'muslim';
        if (key.includes('‡¶§‡¶ø‡¶∞‡¶Æ‡¶ø')) return 'tirmidhi';
        if (key.includes('‡¶Ü‡¶¨‡ßÅ‡¶¶‡¶æ‡¶â‡¶¶')) return 'abudawud';
        if (key.includes('‡¶®‡¶æ‡¶∏‡¶æ‡¶à')) return 'nasai';
        if (key.includes('‡¶á‡¶¨‡¶®‡ßá‡¶Æ‡¶æ‡¶ú‡¶æ‡¶π')) return 'ibnmajah';
        if (key.includes('‡¶Æ‡ßÅ‡¶Ø‡¶º‡¶æ‡¶§‡ßç‡¶§‡¶æ') || key.includes('‡¶Æ‡ßÅ‡ßü‡¶æ‡¶§‡ßç‡¶§‡¶æ')) return 'malik';
        if (key.includes('‡¶Æ‡ßÅ‡¶∏‡¶®‡¶æ‡¶¶‡¶Ü‡¶π‡¶Æ‡¶¶')) return 'ahmad';
        return null;
      },

      getUrl: (book, number) => {
        const id = HadithVerifier.normalizeBook(book);
        const no = toEnglishDigits(number);
        if (!id) return `https://sunnah.com/search?q=${encodeURIComponent(`${book} ${no}`)}`;
        return `https://sunnah.com/${id}:${no}`;
      },

      verify: (book, number, statusId) => {
        const url = HadithVerifier.getUrl(book, number);
        if (statusId) {
          const el = document.getElementById(statusId);
          if (el) el.innerHTML = `‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ñ‡ßã‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: <a href="${url}" target="_blank" rel="noopener">${book} ${number}</a>`;
        }
        window.open(url, '_blank', 'noopener');
      }
    };

    const ArabicAssist = {
      play: (text, statusId) => {
        const value = String(text || '').trim();
        if (!value) return;
        try {
          if (typeof responsiveVoice !== 'undefined') {
            responsiveVoice.speak(value, "Arabic Male", { rate: 0.9 });
          } else if ('speechSynthesis' in window) {
            const u = new SpeechSynthesisUtterance(value);
            u.lang = 'ar-SA';
            u.rate = 0.9;
            window.speechSynthesis.speak(u);
          }
          if (statusId) {
            const el = document.getElementById(statusId);
            if (el) el.innerText = '‡¶Ü‡¶∞‡¶¨‡¶ø ‡¶Ö‡¶°‡¶ø‡¶ì ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶π‡ßü‡ßá‡¶õ‡ßá';
          }
        } catch (e) {
          if (statusId) {
            const el = document.getElementById(statusId);
            if (el) el.innerText = '‡¶Ü‡¶∞‡¶¨‡¶ø ‡¶Ö‡¶°‡¶ø‡¶ì ‡¶ö‡¶æ‡¶≤‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø';
          }
        }
      },

      pronounce: async (text, statusId) => {
        const value = String(text || '').trim();
        const setStatus = (html) => {
          if (!statusId) return;
          const el = document.getElementById(statusId);
          if (el) el.innerHTML = html;
        };
        if (!value) return;
        if (!navigator.onLine) {
          setStatus('‡¶â‡¶ö‡ßç‡¶ö‡¶æ‡¶∞‡¶£ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®');
          return;
        }

        const key = localStorage.getItem('geminiKey');
        const model = localStorage.getItem('geminiModel') || 'gemini-1.5-flash';
        if (!key) {
          setStatus('‡¶â‡¶ö‡ßç‡¶ö‡¶æ‡¶∞‡¶£ ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá Gemini API Key ‡¶¶‡¶ø‡¶®');
          return;
        }

        setStatus('‡¶â‡¶ö‡ßç‡¶ö‡¶æ‡¶∞‡¶£ ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
        try {
          const prompt = `‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶Ü‡¶∞‡¶¨‡¶ø ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü‡ßá‡¶∞ ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶â‡¶ö‡ßç‡¶ö‡¶æ‡¶∞‡¶£ ‡¶¶‡¶æ‡¶ì, ‡¶¨‡¶æ‡ßú‡¶§‡¶ø ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶®‡ßü:\n${value}`;
          const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
          const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.1 } })
          });
          const data = await res.json();
          const pronunciation = data && data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]
            ? String(data.candidates[0].content.parts[0].text || '').trim()
            : '';
          if (!pronunciation) throw new Error('pronunciation-empty');
          setStatus(`<b>‡¶â‡¶ö‡ßç‡¶ö‡¶æ‡¶∞‡¶£:</b> ${pronunciation}`);
        } catch (e) {
          setStatus('‡¶â‡¶ö‡ßç‡¶ö‡¶æ‡¶∞‡¶£ ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá');
        }
      }
    };


    // ==========================================
    // 2. NAMAZ MODULE & AUDIO ENGINE
    // ==========================================
    const NamazAudioEngine = (function () {
      let currentAudio = null;

      return {
        play: (text, reference) => {
          if (currentAudio) {
            currentAudio.pause();
            currentAudio = null;
          }
          if (Logic.isSpeaking) Logic.stopSpeak();

          // Check if it's a Quranic reference
          if (reference && reference.includes('‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶®')) {
            const match = reference.match(/‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶®\s*(\d+):(\d+)-?(\d+)?/);
            if (match) {
              const surah = parseInt(match[1]);
              const start = parseInt(match[2]);
              const end = match[3] ? parseInt(match[3]) : start;
              let current = start;

              const playNext = async () => {
                if (current > end) return;
                UIEngine.showToast("‡¶ï‡ßç‡¶¨‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶§‡¶ø‡¶≤‡¶æ‡¶ì‡ßü‡¶æ‡¶§ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
                try {
                  const res = await fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${current}/ar.alafasy`);
                  const data = await res.json();
                  currentAudio = new Audio(data.data.audio);
                  currentAudio.onended = () => { current++; playNext(); };
                  currentAudio.play();
                } catch (e) {
                  UIEngine.showToast("‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü-‡¶ü‡ßÅ-‡¶∏‡ßç‡¶™‡¶ø‡¶ö ‡¶ö‡¶≤‡¶õ‡ßá...");
                  fallbackTTS(text);
                }
              };
              playNext();
              return;
            }
          }

          // Fallback / Non-Quranic: Use TTS
          fallbackTTS(text);
        },
        stop: () => {
          if (currentAudio) {
            currentAudio.pause();
            currentAudio = null;
          }
          if (Logic.isSpeaking) Logic.stopSpeak();
        }
      };

      function fallbackTTS(text) {
        const cleanText = text.replace(/<[^>]*>/g, '').replace(/[\u0600-\u06FF]/g, ' ').substring(0, 500);
        if (typeof responsiveVoice !== 'undefined') {
          Logic.isSpeaking = true;
          responsiveVoice.speak(cleanText, "Bengali Female", { rate: 0.9, onend: () => Logic.isSpeaking = false });
        } else if ('speechSynthesis' in window) {
          Logic.isSpeaking = true;
          const utterance = new SpeechSynthesisUtterance(cleanText);
          utterance.lang = 'bn-BD';
          utterance.rate = 0.9;
          utterance.onend = () => Logic.isSpeaking = false;
          window.speechSynthesis.speak(utterance);
        }
      }
    })();

    const NamazModule = (function () {
      let namazData = null;

      const esc = (v) => String(v || '').replace(/'/g, "\\'");
      const labelize = (k) => String(k || '').replace(/_/g, ' ');

      const loadData = async () => {
        if (window.NamazData) {
          namazData = window.NamazData;
          return true;
        }
        if (namazData) return true;
        try {
          const res = await fetch('namazshikkha.json');
          namazData = await res.json();
          return true;
        } catch (e) {
          console.error("Failed to load namazshikkha.json", e);
          UIEngine.showToast("‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§");
          return false;
        }
      };

      const showDetailHtml = (html) => {
        document.getElementById('namazListContainer').style.display = 'none';
        const detailContainer = document.getElementById('namazDetailContainer');
        detailContainer.innerHTML = `
          <div style="margin-bottom: 14px;">
            <button class="btn-outline" style="display:inline-flex; width:auto; padding:6px 14px;" onclick="NamazModule.backToList()">
              <span class="material-symbols-rounded">arrow_back</span> ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ‡ßü ‡¶´‡¶ø‡¶∞‡ßÅ‡¶®
            </button>
          </div>
          ${html}
        `;
        detailContainer.style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };

      const renderPrimitive = (value) => {
        if (value === null || value === undefined) return '';
        return `<div style="font-size: 14px; line-height: 1.6;">${value}</div>`;
      };

      const renderValue = (value, keyName = '') => {
        if (value === null || value === undefined) return '';
        if (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') {
          if (typeof value === 'string' && keyName === 'audio_url') {
            return `
              <div style="display:grid; gap:8px;">
                <audio controls preload="none" src="${value}" style="width:100%;"></audio>
                <a href="${value}" target="_blank" rel="noopener" class="btn-mini" style="width:fit-content; text-decoration:none;">‡¶Ö‡¶°‡¶ø‡¶ì ‡¶≤‡¶ø‡¶Ç‡¶ï</a>
              </div>
            `;
          }
          if (typeof value === 'string' && keyName === 'image_url') {
            return `
              <div style="display:grid; gap:8px;">
                <img src="${value}" alt="Step Visual" style="max-width:100%; border-radius:12px; border:1px solid var(--border-color); background:var(--bg-main);" loading="lazy">
                <a href="${value}" target="_blank" rel="noopener" class="btn-mini" style="width:fit-content; text-decoration:none;">‡¶õ‡¶¨‡¶ø ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®</a>
              </div>
            `;
          }
          return renderPrimitive(value);
        }

        if (Array.isArray(value)) {
          if (!value.length) return '';
          if (typeof value[0] === 'string' || typeof value[0] === 'number') {
            return `<ul style="padding-left: 20px; margin: 0;">${value.map(v => `<li style="margin-bottom: 8px;">${v}</li>`).join('')}</ul>`;
          }
          return value.map((item, idx) => `
            <div class="mag-section color-6" style="margin-bottom: 12px;">
              <div class="mag-header">${labelize(keyName)} ${idx + 1}</div>
              <div class="mag-body">${renderValue(item, keyName)}</div>
            </div>
          `).join('');
        }

        if (typeof value === 'object') {
          if (value.arabic || value.transliteration || value.translation || value.meaning || value.pronunciation) {
            return `
              ${value.arabic ? `<div style="font-size: 22px; font-family: 'Amiri', serif; text-align: right; margin-bottom: 10px;" dir="rtl">${value.arabic}</div>` : ''}
              ${value.transliteration ? `<div style="font-size: 14px; font-style: italic; color: var(--text-secondary); margin-bottom: 8px;">‡¶â‡¶ö‡ßç‡¶ö‡¶æ‡¶∞‡¶£: ${value.transliteration}</div>` : ''}
              ${value.pronunciation ? `<div style="font-size: 14px; font-style: italic; color: var(--text-secondary); margin-bottom: 8px;">‡¶â‡¶ö‡ßç‡¶ö‡¶æ‡¶∞‡¶£: ${value.pronunciation}</div>` : ''}
              ${value.translation ? `<div style="font-size: 15px; margin-bottom: 8px;">‡¶Ö‡¶∞‡ßç‡¶•: ${value.translation}</div>` : ''}
              ${value.meaning ? `<div style="font-size: 15px; margin-bottom: 8px;">‡¶Ö‡¶∞‡ßç‡¶•: ${value.meaning}</div>` : ''}
            `;
          }

          const skipKeys = ['name_bn', 'title', 'description', 'type', 'total_rakats', 'total_takbirs', 'notes', 'time', 'id'];
          return Object.keys(value).filter(k => !skipKeys.includes(k)).map(k => `
            <div style="margin-bottom: 10px;">
              <div style="font-size: 13px; font-weight: 700; color: var(--accent-primary); margin-bottom: 5px;">${labelize(k)}</div>
              ${renderValue(value[k], k)}
            </div>
          `).join('');
        }

        return '';
      };

      const renderStepCard = (stepInput) => {
        const isObj = stepInput && typeof stepInput === 'object' && !Array.isArray(stepInput);
        const stepKey = isObj ? stepInput.step_id : stepInput;
        const stepDict = (typeof stepKey === 'string' && namazData.common_steps) ? namazData.common_steps[stepKey] : null;

        if (!stepDict && !isObj) return '';

        const title = (isObj && stepInput.name_bn) || (stepDict && stepDict.name_bn) || stepKey || '‡¶ß‡¶æ‡¶™';
        const refText = (stepDict && stepDict.reference) || (isObj && stepInput.reference) || '';
        const content = (stepDict && stepDict.content) || (isObj ? stepInput.content : null);
        const stepAudioUrl = (isObj && stepInput.audio_url) || (stepDict && stepDict.audio_url) || '';
        const stepImageUrl = (isObj && stepInput.image_url) || (stepDict && stepDict.image_url) || '';
        const safeAttr = (v) => String(v || '').replace(/"/g, '&quot;');

        let contentHtml = '';
        let playText = '';

        if (typeof content === 'string') {
          contentHtml = `<div style="font-size: 15px;">${content}</div>`;
          playText = content;
        } else if (content && typeof content === 'object') {
          contentHtml = renderValue(content);
          playText = content.translation || content.meaning || content.transliteration || title;
          if (content.first && content.first.translation) {
            playText = `${content.first.translation} ${content.second && content.second.translation ? content.second.translation : ''}`.trim();
          }
        } else {
          contentHtml = `<div style="font-size: 15px;">${title}</div>`;
          playText = title;
        }

        if (isObj && typeof stepInput.content === 'string') {
          contentHtml = `<div style="font-size: 15px; font-weight: 700; color: var(--accent-primary);">${stepInput.content}</div>`;
          playText = stepInput.content;
        }

        return `
          <div class="mag-section color-8" style="margin-bottom: 16px;">
            <div class="mag-header" style="display:flex; justify-content:space-between; align-items:center;">
              <span>${title}</span>
              ${playText ? `<button class="icon-btn" style="color: white; padding: 4px; background: rgba(0,0,0,0.2); border-radius: 50%;" onclick="NamazAudioEngine.play('${esc(playText)}', '${esc(refText)}')" title="‡¶∂‡ßÅ‡¶®‡ßÅ‡¶®"><span class="material-symbols-rounded" style="font-size: 20px;">volume_up</span></button>` : ''}
            </div>
            <div class="mag-body">
              ${contentHtml}
              ${stepImageUrl ? `<div style="margin-top:12px;"><img src="${safeAttr(stepImageUrl)}" alt="${safeAttr(title)}" loading="lazy" style="max-width:100%; border-radius:12px; border:1px solid var(--border-color); background:var(--bg-main);"></div>` : ''}
              ${stepAudioUrl ? `<div style="margin-top:12px; display:grid; gap:8px;"><audio controls preload="none" src="${safeAttr(stepAudioUrl)}" style="width:100%;"></audio><a href="${safeAttr(stepAudioUrl)}" target="_blank" rel="noopener" class="btn-mini" style="width:fit-content; text-decoration:none;">‡¶Ö‡¶°‡¶ø‡¶ì ‡¶≤‡¶ø‡¶Ç‡¶ï</a></div>` : ''}
              ${refText ? `<div style="margin-top: 12px; font-size: 12px; opacity: 0.8;"><b>‡¶¶‡¶≤‡¶ø‡¶≤:</b> ${refText}</div>` : ''}
            </div>
          </div>
        `;
      };

      const renderRakatBlocks = (rakats) => {
        if (!Array.isArray(rakats)) return '';
        let html = '';
        rakats.forEach((rakat, idx) => {
          html += `<h3 style="font-size: 18px; margin: 24px 0 16px 0; border-bottom: 2px solid var(--border-color); padding-bottom: 8px;">‡¶∞‡¶æ‡¶ï‡¶æ‡¶§ ${rakat.rakat_no || (idx + 1)}</h3>`;
          const steps = Array.isArray(rakat.steps) ? rakat.steps : [];
          steps.forEach(step => {
            html += renderStepCard(step);
          });
        });
        return html;
      };

      const renderList = () => {
        if (!namazData) {
          document.getElementById('namazListContainer').innerHTML = '<div class="q-card"><span style="font-weight:700;">‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</span></div>';
          return;
        }

        const prayerCount = Array.isArray(namazData.prayers) ? namazData.prayers.length : 0;
        const specialCount = Object.keys(namazData.special_prayers || {}).length;
        const annualCount = Object.keys(namazData.special_prayers_annual || {}).length;
        const taharatCount = Object.keys(namazData.taharat || {}).length;
        const forbiddenCount = Array.isArray(namazData.forbidden_times)
          ? namazData.forbidden_times.length
          : (Array.isArray(namazData.forbidden_times && namazData.forbidden_times.times) ? namazData.forbidden_times.times.length : 0);

        const sectionTitle = (txt) => `<div style="grid-column: 1 / -1; margin: 14px 0 4px; font-size: 17px; font-weight: 800; color: var(--accent-primary);">${txt}</div>`;
        const listCard = (title, subtitle, icon, onClick, accent = 'var(--accent-primary)') => `
          <div class="q-card" style="display:flex; flex-direction:column; align-items:flex-start; gap:8px; border-left:4px solid ${accent};" onclick="${onClick}">
            <div style="display:flex; align-items:center; gap:8px;">
              <span class="material-symbols-rounded">${icon}</span>
              <span style="font-size: 16px; font-weight: 700;">${title}</span>
            </div>
            ${subtitle ? `<div style="font-size: 12px; color: var(--text-secondary);">${subtitle}</div>` : ''}
          </div>
        `;

        let html = `
          <div style="grid-column: 1 / -1; border-radius: 18px; padding: 18px; margin-bottom: 4px; background: linear-gradient(135deg, #0f766e 0%, #0369a1 55%, #1d4ed8 100%); color: #fff; box-shadow: 0 12px 24px rgba(2,132,199,.25);">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
              <div>
                <div style="font-size: 20px; font-weight: 900; margin-bottom: 6px;">‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞</div>
                <div style="font-size: 13px; opacity: .95;">‡¶ì‡ßü‡¶æ‡¶ï‡ßç‡¶§‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú, ‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶á‡¶¨‡¶æ‡¶¶‡¶§, ‡¶ï‡¶æ‡¶ú‡¶æ ‡¶¨‡¶ø‡¶ß‡¶æ‡¶®, ‡¶§‡¶æ‡¶π‡¶æ‡¶∞‡¶æ‡¶§ ‡¶ì ‡¶¶‡¶≤‡¶ø‡¶≤‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶ó‡¶æ‡¶á‡¶°</div>
              </div>
              <div style="display:grid; grid-template-columns: repeat(3, minmax(72px, 1fr)); gap:8px; min-width: 220px;">
                <div style="background: rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.22); border-radius:12px; padding:8px; text-align:center;"><div style="font-size:18px; font-weight:800;">${prayerCount}</div><div style="font-size:11px;">‡¶ì‡ßü‡¶æ‡¶ï‡ßç‡¶§</div></div>
                <div style="background: rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.22); border-radius:12px; padding:8px; text-align:center;"><div style="font-size:18px; font-weight:800;">${specialCount + annualCount}</div><div style="font-size:11px;">‡¶¨‡¶ø‡¶∂‡ßá‡¶∑</div></div>
                <div style="background: rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.22); border-radius:12px; padding:8px; text-align:center;"><div style="font-size:18px; font-weight:800;">${taharatCount}</div><div style="font-size:11px;">‡¶§‡¶æ‡¶π‡¶æ‡¶∞‡¶æ‡¶§</div></div>
              </div>
            </div>
            ${forbiddenCount ? `<div style="margin-top:10px; font-size:12px; opacity:.9;">‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß/‡¶Æ‡¶æ‡¶ï‡¶∞‡ßÅ‡¶π ‡¶∏‡¶Æ‡ßü: ${forbiddenCount} ‡¶ü‡¶ø</div>` : ''}
          </div>
        `;

        if (prayerCount) {
          html += sectionTitle('‡¶ì‡ßü‡¶æ‡¶ï‡ßç‡¶§‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú');
          namazData.prayers.forEach(p => {
            html += listCard(p.name_bn, p.time || '', 'schedule', `NamazModule.showPrayerDetails('${esc(p.id)}')`, '#0ea5e9');
          });
        }

        if (namazData.special_prayers) {
          const entries = Object.entries(namazData.special_prayers);
          if (entries.length) {
            html += sectionTitle('‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú ‡¶ì ‡¶á‡¶¨‡¶æ‡¶¶‡¶§');
            entries.forEach(([key, item]) => {
              const subtitle = item.type || item.hijri_timing || (item.total_rakats ? `${item.total_rakats} ‡¶∞‡¶æ‡¶ï‡¶æ‡¶§` : '‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§');
              html += listCard(item.name_bn || key, subtitle, 'auto_stories', `NamazModule.showSpecialDetails('${esc(key)}')`, '#14b8a6');
            });
          }
        }

        if (namazData.special_prayers_annual) {
          const entries = Object.entries(namazData.special_prayers_annual);
          if (entries.length) {
            html += sectionTitle('‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú ‡¶ì ‡¶Ü‡¶Æ‡¶≤');
            entries.forEach(([key, item]) => {
              const subtitle = item.importance || item.description || item.ruling || '‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶Ü‡¶Æ‡¶≤';
              html += listCard(item.name_bn || key, subtitle, 'event', `NamazModule.showAnnualSpecialDetails('${esc(key)}')`, '#22c55e');
            });
          }
        }

        if (namazData.taharat) {
          const entries = Object.entries(namazData.taharat);
          if (entries.length) {
            html += sectionTitle('‡¶§‡¶æ‡¶π‡¶æ‡¶∞‡¶æ‡¶§ ‡¶ì ‡¶™‡¶¨‡¶ø‡¶§‡ßç‡¶∞‡¶§‡¶æ');
            entries.forEach(([key, item]) => {
              html += listCard(item.name_bn || key, item.evidence || item.condition || '', 'water_drop', `NamazModule.showTaharatDetails('${esc(key)}')`, '#3b82f6');
            });
          }
        }

        if (namazData.adhan_iqamah) {
          html += sectionTitle('‡¶Ü‡¶Ø‡¶æ‡¶® ‡¶ì ‡¶á‡¶ï‡¶æ‡¶Æ‡¶æ‡¶§');
          html += listCard('‡¶Ü‡¶Ø‡¶æ‡¶®', '‡¶Ü‡¶ú‡¶æ‡¶®‡ßá‡¶∞ ‡¶∂‡¶¨‡ßç‡¶¶, ‡¶ú‡¶¨‡¶æ‡¶¨ ‡¶ì ‡¶¶‡ßã‡ßü‡¶æ', 'campaign', `NamazModule.showAdhanIqamahDetails('adhan')`, '#f59e0b');
          html += listCard('‡¶á‡¶ï‡¶æ‡¶Æ‡¶æ‡¶§', '‡¶á‡¶ï‡¶æ‡¶Æ‡¶æ‡¶§‡ßá‡¶∞ ‡¶®‡¶ø‡ßü‡¶Æ ‡¶ì ‡¶∂‡¶¨‡ßç‡¶¶‡¶∏‡¶Æ‡ßÇ‡¶π', 'notifications_active', `NamazModule.showAdhanIqamahDetails('iqamah')`, '#f97316');
        }

        if (forbiddenCount) {
          html += sectionTitle('‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß ‡¶∏‡¶Æ‡ßü');
          html += listCard('‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß ‡¶∏‡¶Æ‡ßü‡¶∏‡¶Æ‡ßÇ‡¶π', `${forbiddenCount} ‡¶ü‡¶ø ‡¶∏‡¶Æ‡ßü`, 'schedule', `NamazModule.showForbiddenTimes()`, '#ef4444');
        }

        if (namazData.qaza_prayers || namazData.qaza_namaz_rules) {
          html += sectionTitle('‡¶ï‡¶æ‡¶ú‡¶æ ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú');
          html += listCard('‡¶ï‡¶æ‡¶ú‡¶æ ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶®‡¶ø‡ßü‡¶Æ', '‡¶®‡¶ø‡ßü‡¶§, ‡¶ß‡¶æ‡¶™, ‡¶ß‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ‡¶π‡¶ø‡¶ï‡¶§‡¶æ ‡¶ì ‡¶Æ‡¶æ‡¶∏-‡¶ï‡¶æ‡¶ú‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶®‡¶æ', 'history', `NamazModule.showQazaRules()`, '#a855f7');
        }

        if (!html) {
          html = `<div class="q-card"><span style="font-weight:700;">‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</span></div>`;
        }

        const listContainer = document.getElementById('namazListContainer');
        listContainer.innerHTML = html;
        listContainer.style.display = 'grid';
        document.getElementById('namazDetailContainer').style.display = 'none';
      };

      const renderInfoBlock = (item) => {
        let html = `
          <div style="margin-bottom: 20px;">
            <h2 style="font-size: 22px; color: var(--accent-primary); margin-bottom: 8px;">${item.name_bn || item.title || '‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§'}</h2>
            ${item.description ? `<div style="margin-top:8px; padding:12px; background:var(--bg-main); border-radius:8px; font-size:13px;">${item.description}</div>` : ''}
          </div>
        `;

        if (Array.isArray(item.rakats_detail)) {
          html += renderRakatBlocks(item.rakats_detail);
        } else if (Array.isArray(item.steps)) {
          item.steps.forEach((s, idx) => {
            html += renderStepCard({
              step_id: `inline_step_${idx}`,
              name_bn: s.action || `‡¶ß‡¶æ‡¶™ ${idx + 1}`,
              content: s.content,
              reference: s.reference
            });
          });
        } else {
          html += renderValue(item);
        }

        if (item.loop_instruction) {
          html += `<div class="mag-section color-5"><div class="mag-header">‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶®‡¶æ</div><div class="mag-body">${item.loop_instruction}</div></div>`;
        }

        if (item.between_rakats_dua) {
          const duaStep = namazData.common_steps && namazData.common_steps[item.between_rakats_dua];
          if (duaStep) {
            html += `<h3 style="font-size: 18px; margin: 24px 0 12px 0;">‡¶∞‡¶æ‡¶ï‡¶æ‡¶§‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ù‡ßá ‡¶§‡¶æ‡¶∏‡¶¨‡¶ø‡¶π</h3>${renderStepCard(item.between_rakats_dua)}`;
          }
        }

        return html;
      };

      return {
        init: loadData,
        backToList: () => renderList(),
        showNamazView: async (fromHistory = false) => {
          document.getElementById('qContainer').style.display = 'none';
          document.querySelector('.cat-scroll-container').style.display = 'none';
          document.getElementById('resultArea').style.display = 'none';
          document.getElementById('namazArea').style.display = 'block';
          Logic.currentView = 'namaz';
          if (!fromHistory && !Logic.historySyncing) Logic.pushViewState('namaz');
          StorageEngine.setState('lastActivity', { type: 'namaz', ts: Date.now() });

          UIEngine.startGamifiedLoader();
          document.getElementById('loaderText').innerText = "‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ü‡¶®‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
          await loadData();
          UIEngine.stopLoader();
          renderList();
        },
        showPrayerDetails: (prayerId) => {
          if (!namazData || !Array.isArray(namazData.prayers)) return;
          const prayer = namazData.prayers.find(p => p.id === prayerId);
          if (!prayer) return;
          const html = `
            <div style="margin-bottom: 20px;">
              <h2 style="font-size: 22px; color: var(--accent-primary); margin-bottom: 8px;">${prayer.name_bn}</h2>
              <p style="font-size: 14px; color: var(--text-secondary);"><span class="material-symbols-rounded" style="font-size:16px; vertical-align:middle;">schedule</span> ‡¶∏‡¶Æ‡ßü: ${prayer.time || '-'}</p>
              ${prayer.notes ? `<div style="margin-top:8px; padding:12px; background:var(--bg-main); border-radius:8px; font-size:13px;">${prayer.notes}</div>` : ''}
            </div>
            ${renderRakatBlocks(prayer.rakats_detail)}
          `;
          showDetailHtml(html);
        },
        showSpecialDetails: (key) => {
          if (!namazData || !namazData.special_prayers || !namazData.special_prayers[key]) return;
          showDetailHtml(renderInfoBlock(namazData.special_prayers[key]));
        },
        showAnnualSpecialDetails: (key) => {
          if (!namazData || !namazData.special_prayers_annual || !namazData.special_prayers_annual[key]) return;
          showDetailHtml(renderInfoBlock(namazData.special_prayers_annual[key]));
        },
        showTaharatDetails: (key) => {
          if (!namazData || !namazData.taharat || !namazData.taharat[key]) return;
          showDetailHtml(renderInfoBlock(namazData.taharat[key]));
        },
        showAdhanIqamahDetails: (type) => {
          if (!namazData || !namazData.adhan_iqamah || !namazData.adhan_iqamah[type]) return;
          showDetailHtml(renderInfoBlock(namazData.adhan_iqamah[type]));
        },
        showForbiddenTimes: () => {
          if (!namazData || !namazData.forbidden_times) return;
          const times = Array.isArray(namazData.forbidden_times)
            ? namazData.forbidden_times
            : (Array.isArray(namazData.forbidden_times.times) ? namazData.forbidden_times.times : []);
          const title = namazData.forbidden_times.title || '‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß ‡¶∏‡¶Æ‡ßü‡¶∏‡¶Æ‡ßÇ‡¶π';
          const desc = namazData.forbidden_times.description || '';
          if (!times.length) return;
          showDetailHtml(`
            <h2 style="font-size: 22px; color: var(--accent-primary); margin-bottom: 10px;">${title}</h2>
            ${desc ? `<div style="margin-bottom: 14px; padding: 12px; border-radius: 10px; background: var(--bg-main); font-size: 13px;">${desc}</div>` : ''}
            ${times.map(item => `
              <div class="mag-section color-4" style="margin-bottom: 12px;">
                <div class="mag-header">${item.name || item.time}</div>
                <div class="mag-body">
                  <div style="margin-bottom:6px;"><b>‡¶∏‡¶Æ‡ßü:</b> ${item.duration}</div>
                  <div><b>‡¶¨‡¶ø‡¶ß‡¶æ‡¶®:</b> ${item.ruling}</div>
                  ${item.evidence ? `<div style="margin-top:6px; font-size:12px; opacity:.8;"><b>‡¶¶‡¶≤‡¶ø‡¶≤:</b> ${item.evidence}</div>` : ''}
                </div>
              </div>
            `).join('')}
          `);
        },
        showQazaRules: () => {
          if (!namazData) return;
          const target = namazData.qaza_prayers || namazData.qaza_namaz_rules;
          if (!target) return;
          showDetailHtml(renderInfoBlock(target));
        }
      };
    })();

    // ==========================================
    // 3. STORAGE ENGINE
    // ==========================================
    const StorageEngine = (function () {
      const DB_NAME = 'IslamicKnowledgeV4';
      let dbInstance = null;

      async function initDB() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, 2);
          req.onupgradeneeded = e => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('cache')) db.createObjectStore('cache', { keyPath: 'q' });
            if (!db.objectStoreNames.contains('state')) db.createObjectStore('state', { keyPath: 'key' });
          };
          req.onsuccess = e => { dbInstance = e.target.result; resolve(dbInstance); };
          req.onerror = e => reject(e);
        });
      }

      const keysToSave = ['geminiKey', 'geminiModel', 'orKey', 'orModel', 'grokKey', 'grokModel'];

      return {
        init: async () => await initDB(),
        getCache: async (q) => {
          if (!dbInstance) await initDB();
          return new Promise(resolve => {
            const tx = dbInstance.transaction('cache', 'readonly');
            const req = tx.objectStore('cache').get(q);
            req.onsuccess = () => resolve(req.result ? req.result.a : null);
            req.onerror = () => resolve(null);
          });
        },
        setCache: async (q, a) => {
          if (!dbInstance) await initDB();
          const tx = dbInstance.transaction('cache', 'readwrite');
          tx.objectStore('cache').put({ q, a, ts: Date.now() });
        },
        getState: async (key) => {
          if (!dbInstance) await initDB();
          return new Promise(resolve => {
            const tx = dbInstance.transaction('state', 'readonly');
            const req = tx.objectStore('state').get(key);
            req.onsuccess = () => resolve(req.result ? req.result.value : null);
            req.onerror = () => resolve(null);
          });
        },
        setState: async (key, value) => {
          if (!dbInstance) await initDB();
          const tx = dbInstance.transaction('state', 'readwrite');
          tx.objectStore('state').put({ key, value, ts: Date.now() });
        },
        saveSettings: () => {
          keysToSave.forEach(id => {
            const val = document.getElementById(id).value.trim();
            if (val) localStorage.setItem(id, val);
          });
          localStorage.setItem('parallelMode', document.getElementById('parallelToggle').checked);
          UI.showToast("‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá");
          UI.closeModal('settingsModal');
        },
        loadSettings: () => {
          keysToSave.forEach(id => {
            if (localStorage.getItem(id)) document.getElementById(id).value = localStorage.getItem(id);
          });
          document.getElementById('parallelToggle').checked = localStorage.getItem('parallelMode') === 'true';
        },
        clearCache: async () => {
          if (!dbInstance) await initDB();
          const tx = dbInstance.transaction('cache', 'readwrite');
          tx.objectStore('cache').clear();
          UI.showToast("‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        },
        getArray: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
        pushArray: (key, obj) => {
          let arr = JSON.parse(localStorage.getItem(key) || '[]');
          // Prevent duplicate bookmarks
          if (key === 'bookmark' && arr.find(x => x.q === obj.q)) return false;
          arr.unshift(obj);
          if (arr.length > 30) arr.pop();
          localStorage.setItem(key, JSON.stringify(arr));
          return true;
        }
      };
    })();


    // ==========================================
    // 3.5 SYSTEM HUB (Homepage Visibility/Sync/PWA)
    // ==========================================
    const SystemHub = (function () {
      let deferredInstallPrompt = null;
      let swRegistered = false;

      const CORE_FILES = ['islamic.html', 'quran.html', 'ans.json', 'question.json', 'namazshikkha.json', 'manifest.json', 'sw.js'];

      const byId = (id) => document.getElementById(id);
      const fmtTime = (ts) => ts ? new Date(ts).toLocaleString('bn-BD') : '-';

      const isInstalled = () => {
        const standalone = window.matchMedia && window.matchMedia('(display-mode: standalone)').matches;
        return !!(standalone || window.navigator.standalone || localStorage.getItem('appInstalled') === '1');
      };

      const setPill = (id, text, mode) => {
        const el = byId(id);
        if (!el) return;
        el.textContent = text;
        el.className = `status-pill ${mode || ''}`.trim();
      };

      const setMessage = (text) => {
        const el = byId('sysMessage');
        if (el) el.textContent = text;
      };

      const refreshStatus = async () => {
        const online = navigator.onLine;
        setPill('sysOnlineBadge', online ? '‡¶®‡ßá‡¶ü‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï: Online' : '‡¶®‡ßá‡¶ü‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï: Offline', online ? 'ok' : 'warn');

        let hasSw = false;
        if ('serviceWorker' in navigator) {
          try {
            const reg = await navigator.serviceWorker.getRegistration();
            hasSw = !!reg || swRegistered;
          } catch (e) {
            hasSw = swRegistered;
          }
        }
        setPill('sysSwBadge', hasSw ? '‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶á‡¶û‡ßç‡¶ú‡¶ø‡¶®: Active' : '‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶á‡¶û‡ßç‡¶ú‡¶ø‡¶®: Missing', hasSw ? 'ok' : 'error');

        const installed = isInstalled();
        const canInstall = !!deferredInstallPrompt;
        const installBtn = byId('installAppBtn');
        if (installBtn) {
          installBtn.disabled = installed;
          installBtn.style.opacity = installed ? '0.6' : '1';
        }
        if (installed) setPill('sysInstallBadge', '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤: ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®', 'ok');
        else if (canInstall) setPill('sysInstallBadge', '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤: ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§', 'warn');
        else setPill('sysInstallBadge', '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤: ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶∏‡¶ø‡¶¶‡ßç‡¶ß‡¶æ‡¶®‡ßç‡¶§‡¶æ‡¶ß‡ßÄ‡¶®', 'warn');

        const catCount = Array.isArray(DataModule.categories) ? Math.max(0, DataModule.categories.length - 1) : 0;
        const qCount = Array.isArray(DataModule.questions) ? DataModule.questions.length : 0;
        const hasNamaz = !!(window.NamazData && (window.NamazData.prayers || window.NamazData.taharat || window.NamazData.special_prayers || window.NamazData.special_prayers_annual || window.NamazData.qaza_prayers));
        const dataMode = qCount > 0 ? 'ok' : 'error';
        setPill('sysDataBadge', `‡¶°‡¶æ‡¶ü‡¶æ: ${catCount} ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø, ${qCount} ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®${hasNamaz ? ', ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú OK' : ''}`, dataMode);

        const syncLabel = byId('sysLastSync');
        if (syncLabel) syncLabel.textContent = `‡¶∏‡¶ø‡¶ô‡ßç‡¶ï: ${fmtTime(DataModule.lastLoadedAt)}`;
      };

      const syncNow = async () => {
        setMessage('Sync ‡¶ö‡¶≤‡¶õ‡ßá...');
        try {
          if ('serviceWorker' in navigator) {
            const reg = await navigator.serviceWorker.getRegistration();
            if (reg) await reg.update();
          }
          await DataModule.loadData();
          await NamazModule.init();
          UIEngine.renderCategories('all');
          UIEngine.renderQuestions('all');
          const namazArea = document.getElementById('namazArea');
          if (namazArea && namazArea.style.display !== 'none') {
            await NamazModule.showNamazView();
          }
          setMessage('Sync ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
          await refreshStatus();
        } catch (e) {
          console.error('Sync failed', e);
          setMessage('Sync ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
          UIEngine.showToast('Sync ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
        }
      };

      const warmOffline = async () => {
        if (!('caches' in window)) {
          setMessage('Browser cache API ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ‡•§');
          return;
        }
        setMessage('Offline cache ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
        try {
          const cache = await caches.open('islamic-manual-cache-v1');
          const results = await Promise.allSettled(
            CORE_FILES.map(file => cache.add(new Request(file, { cache: 'reload' })))
          );
          const ok = results.filter(r => r.status === 'fulfilled').length;
          setMessage(`Offline save: ${ok}/${CORE_FILES.length} ‡¶´‡¶æ‡¶á‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
          UIEngine.showToast('Offline cache ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
        } catch (e) {
          console.error('Warm offline failed', e);
          setMessage('Offline cache ‡¶§‡ßà‡¶∞‡¶ø ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
        }
      };

      const viewFile = async (file) => {
        const title = byId('fileViewerTitle');
        const body = byId('fileViewerBody');
        if (title) title.textContent = `‡¶´‡¶æ‡¶á‡¶≤ ‡¶≠‡¶ø‡¶â: ${file}`;
        if (body) body.textContent = '‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
        UIEngine.openModal('fileViewerModal');

        try {
          const res = await fetch(file, { cache: 'no-store' });
          if (!res.ok) throw new Error('‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø');
          const text = await res.text();
          if (body) body.textContent = text;
        } catch (e) {
          if (body) body.textContent = `‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ${e.message}`;
        }
      };

      const downloadFile = (file) => {
        const a = document.createElement('a');
        a.href = file;
        a.download = file;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setMessage(`${file} ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
      };

      const installApp = async () => {
        if (isInstalled()) {
          UIEngine.showToast('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶Ü‡¶ó‡ßá ‡¶•‡ßá‡¶ï‡ßá‡¶á ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá‡•§');
          return;
        }
        if (!deferredInstallPrompt) {
          UIEngine.showToast('‡¶è‡¶á ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏‡ßá ‡¶è‡¶ñ‡¶®‡¶á Install prompt ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§');
          await refreshStatus();
          return;
        }
        deferredInstallPrompt.prompt();
        const result = await deferredInstallPrompt.userChoice;
        deferredInstallPrompt = null;
        if (result && result.outcome === 'accepted') {
          localStorage.setItem('appInstalled', '1');
          setMessage('Install ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
        } else {
          setMessage('Install ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
        }
        await refreshStatus();
      };

      const resumeLastActivity = async () => {
        try {
          const activity = await StorageEngine.getState('lastActivity');
          if (!activity || !activity.type) {
            UIEngine.showToast('‡¶ï‡ßã‡¶®‡ßã last activity ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§');
            return;
          }

          if (activity.type === 'result' && activity.q) {
            const aiToggle = document.getElementById('aiToggle');
            if (aiToggle && typeof activity.askAI === 'boolean') aiToggle.checked = activity.askAI;
            await Logic.ask(activity.q);
            return;
          }

          if (activity.type === 'namaz') {
            await NamazModule.showNamazView(true);
            return;
          }

          if (activity.type === 'quran_reader') {
            window.location.href = 'quran.html';
            return;
          }

          UIEngine.showToast('Last activity format ‡¶∏‡¶Æ‡¶∞‡ßç‡¶•‡¶ø‡¶§ ‡¶®‡ßü‡•§');
        } catch (e) {
          UIEngine.showToast('Last activity restore ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
        }
      };

      const onServiceWorkerRegistered = async () => {
        swRegistered = true;
        await refreshStatus();
      };

      const init = async () => {
        window.addEventListener('beforeinstallprompt', (event) => {
          event.preventDefault();
          deferredInstallPrompt = event;
          refreshStatus();
        });
        window.addEventListener('appinstalled', () => {
          localStorage.setItem('appInstalled', '1');
          deferredInstallPrompt = null;
          refreshStatus();
        });
        await refreshStatus();
        setMessage('‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡•§');
      };

      return {
        init,
        refreshStatus,
        syncNow,
        warmOffline,
        viewFile,
        downloadFile,
        installApp,
        resumeLastActivity,
        onServiceWorkerRegistered
      };
    })();


    // ==========================================
    // 3. VISION PROCESSOR
    // ==========================================
    const VisionProcessor = (function () {
      let currentBase64 = null;

      return {
        handleImage: (event) => {
          const file = event.target.files[0];
          if (!file) return;

          const img = new Image();
          const reader = new FileReader();

          reader.onload = e => {
            img.src = e.target.result;
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              let w = img.width, h = img.height;
              if (w > 1024) { h *= 1024 / w; w = 1024; }
              canvas.width = w; canvas.height = h;
              ctx.drawImage(img, 0, 0, w, h);
              currentBase64 = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];

              document.getElementById('visionIndicator').style.display = 'block';
              UI.showToast("‡¶õ‡¶¨‡¶ø ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶è‡¶¨‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            };
          };
          reader.readAsDataURL(file);
        },
        getImage: () => currentBase64,
        clearImage: () => {
          currentBase64 = null;
          document.getElementById('visionIndicator').style.display = 'none';
          document.getElementById('imageInput').value = '';
        }
      };
    })();


    // ==========================================
    // 4. AI ENGINE (Parallel & Failover)
    // ==========================================
    const AIEngine = (function () {
      let abortController = null;

      const promptTemplate = `‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶è‡¶ï‡¶ú‡¶® ‡¶™‡ßç‡¶∞‡¶æ‡¶ú‡ßç‡¶û ‡¶ì ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶∏‡ßç‡¶§ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶™‡¶£‡ßç‡¶°‡¶ø‡¶§‡•§ ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ü‡¶ø‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§, ‡¶¶‡¶≤‡¶ø‡¶≤‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡¶æ‡¶ì‡•§
‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®: "{q}"

‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶ï‡¶æ‡¶†‡¶æ‡¶Æ‡ßã ‡¶è‡¶¨‡¶Ç ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶π‡ßÅ‡¶¨‡¶π‡ßÅ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá (‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡¶°‡¶æ‡¶â‡¶® ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá):

**‡ßß. ‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™**
**‡ß®. ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ**
**‡ß©. ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶®‡ßá‡¶∞ ‡¶¶‡¶≤‡¶ø‡¶≤** (‡¶Ü‡¶∞‡¶¨‡¶ø, ‡¶â‡¶ö‡ßç‡¶ö‡¶æ‡¶∞‡¶£ ‡¶ì ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶‡¶∏‡¶π)
**‡ß™. ‡¶π‡¶æ‡¶¶‡¶ø‡¶∏‡ßá‡¶∞ ‡¶¶‡¶≤‡¶ø‡¶≤**
**‡ß´. ‡¶á‡¶Æ‡¶æ‡¶Æ‡¶¶‡ßá‡¶∞ ‡¶Æ‡¶§‡¶æ‡¶Æ‡¶§**
**‡ß¨. ‡¶´‡¶ø‡¶ï‡¶π‡¶ø ‡¶®‡ßã‡¶ü (‡¶π‡¶æ‡¶®‡¶æ‡¶´‡ßÄ/‡¶∂‡¶æ‡¶´‡ßá‡ßü‡ßÄ ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™)**
**‡ß≠. ‡¶Ü‡¶∞‡¶¨‡¶ø ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü‡ßá‡¶∞ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶â‡¶ö‡ßç‡¶ö‡¶æ‡¶∞‡¶£**
**‡ßÆ. ‡¶Ü‡¶∞‡¶¨‡¶ø ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü‡ßá‡¶∞ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶∞‡ßç‡¶•**
**‡ßØ. English Summary**
**‡ßß‡ß¶. ‡¶¨‡¶æ‡¶∏‡ßç‡¶§‡¶¨ ‡¶ú‡ßÄ‡¶¨‡¶®‡ßá ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó**
**‡ßß‡ßß. ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ ‡¶ì ‡¶≠‡ßÅ‡¶≤ ‡¶ß‡¶æ‡¶∞‡¶£‡¶æ**
**‡ßß‡ß®. ‡¶â‡¶™‡¶∏‡¶Ç‡¶π‡¶æ‡¶∞ ‡¶ì ‡¶Ü‡¶Æ‡¶≤ ‡¶™‡¶∞‡¶ø‡¶ï‡¶≤‡ßç‡¶™‡¶®‡¶æ**`;

      async function callAPI(provider, q, imageB64) {
        const prompt = promptTemplate.replace('{q}', q);
        let url, headers, body;

        if (provider === 'gemini') {
          const key = localStorage.getItem('geminiKey');
          const model = localStorage.getItem('geminiModel') || 'gemini-1.5-flash';
          if (!key) throw new Error('Gemini Key Missing');
          url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
          let parts = [{ text: prompt }];
          if (imageB64) parts.push({ inlineData: { mimeType: "image/jpeg", data: imageB64 } });
          headers = { 'Content-Type': 'application/json' };
          body = JSON.stringify({ contents: [{ parts }], generationConfig: { temperature: 0.2 } });
        }
        else if (provider === 'openrouter') {
          const key = localStorage.getItem('orKey');
          const model = localStorage.getItem('orModel') || 'deepseek/deepseek-chat';
          if (!key) throw new Error('OpenRouter Key Missing');
          url = 'https://openrouter.ai/api/v1/chat/completions';
          headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` };
          body = JSON.stringify({ model, messages: [{ role: 'user', content: prompt }], temperature: 0.2 });
        }
        else if (provider === 'grok') {
          const key = localStorage.getItem('grokKey');
          const model = localStorage.getItem('grokModel') || 'grok-1';
          if (!key) throw new Error('Grok Key Missing');
          url = 'https://api.x.ai/v1/chat/completions';
          headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` };
          body = JSON.stringify({ model, messages: [{ role: 'user', content: prompt }], temperature: 0.2 });
        }

        const res = await fetch(url, { method: 'POST', headers, body, signal: abortController.signal });
        const data = await res.json();

        if (data.error) throw new Error(data.error.message || "API Error");

        if (provider === 'gemini') return { text: data.candidates[0].content.parts[0].text, source: 'Gemini' };
        return { text: data.choices[0].message.content, source: provider === 'grok' ? 'Grok' : 'OpenRouter' };
      }

      return {
        run: async (q) => {
          if (abortController) abortController.abort();
          abortController = new AbortController();

          const imageB64 = VisionProcessor.getImage();
          const isParallel = document.getElementById('parallelToggle').checked;

          if (isParallel) {
            // PARALLEL EXECUTION (Race Condition)
            const promises = [];
            if (localStorage.getItem('geminiKey')) promises.push(callAPI('gemini', q, imageB64));
            // Only send text to OR/Grok if image is present to avoid payload errors
            if (localStorage.getItem('orKey')) promises.push(callAPI('openrouter', q, null));
            if (localStorage.getItem('grokKey')) promises.push(callAPI('grok', q, null));

            if (promises.length === 0) throw new Error("‡¶ï‡ßã‡¶®‡ßã API Key ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶®‡ßá‡¶á! ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏‡ßá ‡¶ó‡¶ø‡ßü‡ßá Key ‡¶¶‡¶ø‡¶®‡•§");

            try {
              return await Promise.any(promises); // First one to resolve wins
            } catch (e) {
              throw new Error("‡¶∏‡¶¨‡¶ó‡ßÅ‡¶≤‡ßã API ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶¨‡¶æ API Key ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            }
          } else {
            // SEQUENTIAL FAILOVER
            try {
              return await callAPI('gemini', q, imageB64);
            } catch (e1) {
              if (e1.name === 'AbortError') throw e1;
              if (imageB64) throw new Error("‡¶õ‡¶¨‡¶ø ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ Gemini ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßá‡•§ ‡¶∏‡¶†‡¶ø‡¶ï Gemini Key ‡¶¶‡¶ø‡¶®‡•§");

              try {
                return await callAPI('openrouter', q, null);
              } catch (e2) {
                if (e2.name === 'AbortError') throw e2;
                try {
                  return await callAPI('grok', q, null);
                } catch (e3) {
                  throw new Error("‡¶∏‡¶¨‡¶ó‡ßÅ‡¶≤‡ßã API ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
                }
              }
            }
          }
        },

        // Voice Input (STT)
        startVoice: () => {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          if (!SpeechRecognition) {
            UI.showToast('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≠‡ßü‡ßá‡¶∏ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ€î'); return;
          }
          const recognition = new SpeechRecognition();
          recognition.lang = 'bn-BD';

          recognition.onstart = () => {
            document.getElementById('micBtn').classList.add('mic-active');
            UI.showToast("‡¶¨‡¶≤‡ßÅ‡¶®, ‡¶Ü‡¶Æ‡¶ø ‡¶∂‡ßÅ‡¶®‡¶õ‡¶ø...");
          };
          recognition.onresult = (e) => {
            document.getElementById('searchInput').value = e.results[0][0].transcript;
            Logic.handleSearch();
          };
          recognition.onend = () => document.getElementById('micBtn').classList.remove('mic-active');
          recognition.onerror = () => {
            document.getElementById('micBtn').classList.remove('mic-active');
            UI.showToast("‡¶≠‡ßü‡ßá‡¶∏ ‡¶ö‡¶ø‡¶®‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
          };

          recognition.start();
        }
      };
    })();


    // ==========================================
    // 5. UI ENGINE (Magazine Render, Loader, Scroll)
    // ==========================================
    const UIEngine = (function () {
      let loaderInterval;

      function parseMagazine(text) {
        let safeText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        safeText = safeText.replace(/([\u0600-\u06FF\s]{15,})/g, '<div class="arabic-text">$1</div>');

        const parts = safeText.split(/\*\*(.*?)\*\*/g);
        let html = '';

        let colorIndex = 0;

        for (let i = 1; i < parts.length; i += 2) {
          const title = parts[i].trim();
          let content = (parts[i + 1] || '').trim();
          content = content.replace(/\n\*/g, '<br>‚Ä¢').replace(/\n/g, '<br>');

          let colorClass = 'color-' + ((colorIndex % 12) + 1);
          colorIndex++;

          if (title && content) {
            // Add staggered animation delay
            let delay = (i * 0.05).toFixed(2);
            html += `
          <div class="mag-section ${colorClass}" style="animation: slideUp 0.5s ease ${delay}s backwards;">
            <div class="mag-header">${title}</div>
            <div class="mag-body">${content}</div>
          </div>
        `;
          }
        }
        if (html === '') html = `<div class="mag-section color-1"><div class="mag-body">${safeText.replace(/\n/g, '<br>')}</div></div>`;
        return html;
      }

      // Setup Drag to Scroll for Categories
      function setupDragScroll() {
        const slider = document.getElementById('catContainer');
        let isDown = false; let startX; let scrollLeft;

        slider.addEventListener('mousedown', (e) => {
          isDown = true; slider.classList.add('active');
          startX = e.pageX - slider.offsetLeft;
          scrollLeft = slider.scrollLeft;
        });
        slider.addEventListener('mouseleave', () => { isDown = false; slider.classList.remove('active'); });
        slider.addEventListener('mouseup', () => { isDown = false; slider.classList.remove('active'); });
        slider.addEventListener('mousemove', (e) => {
          if (!isDown) return;
          e.preventDefault();
          const x = e.pageX - slider.offsetLeft;
          const walk = (x - startX) * 2; // scroll-fast
          slider.scrollLeft = scrollLeft - walk;
        });
      }

      return {
        initScroll: setupDragScroll,

        renderCategories: (activeId) => {
          let html = '';
          const hasNamazData = !!(window.NamazData && (window.NamazData.prayers || window.NamazData.taharat || window.NamazData.special_prayers || window.NamazData.special_prayers_annual || window.NamazData.qaza_prayers));

          if (hasNamazData) {
            html += `
        <div class="cat-chip ${activeId === 'namaz' ? 'active' : ''}" onclick="NamazModule.showNamazView()">
          <span style="font-size: 18px; margin-right: 4px;">üïå</span> ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ
        </div>
      `;
          }

          html += DataModule.categories.map(c => {
            const iconHtml = c.icon.length <= 2 ? c.icon : `<span class="material-symbols-rounded" style="font-size: 18px;">${c.icon}</span>`;
            return `
        <div class="cat-chip ${c.id === activeId ? 'active' : ''}" onclick="Logic.filterCat('${c.id}')">
          <span style="font-size: 18px; margin-right: 4px;">${iconHtml}</span> ${c.name}
        </div>
      `;
          }).join('');
          document.getElementById('catContainer').innerHTML = html;
        },

        renderQuestions: (filterCat = 'all') => {
          const filtered = filterCat === 'all'
            ? DataModule.questions.slice(0, 40) // Show 40 to prevent DOM lag
            : DataModule.questions.filter(q => q.c === filterCat).slice(0, 40);
          const hasNamazData = !!(window.NamazData && (window.NamazData.prayers || window.NamazData.taharat || window.NamazData.special_prayers || window.NamazData.special_prayers_annual || window.NamazData.qaza_prayers));

          let html = '';
          if (filterCat === 'all' && hasNamazData) {
            html += `
        <div class="q-card" style="animation-delay: 0s; border-left: 4px solid var(--accent-primary);" onclick="NamazModule.showNamazView()">
          <span class="material-symbols-rounded">self_improvement</span>
          <span style="font-size: 15px; font-weight: 700;">‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ (‡¶∏‡ßç‡¶ü‡ßá‡¶™ ‡¶¨‡¶æ‡¶á ‡¶∏‡ßç‡¶ü‡ßá‡¶™)</span>
        </div>
      `;
          }

          html += filtered.map((q, index) => {
            let delay = (index * 0.02).toFixed(2);
            return `
        <div class="q-card" style="animation-delay: ${delay}s" onclick="Logic.ask('${q.q.replace(/'/g, "\\'")}')">
          <span class="material-symbols-rounded">help</span>
          <span style="font-size: 15px; font-weight: 600;">${q.q}</span>
        </div>
      `}).join('');
          document.getElementById('qContainer').innerHTML = html;
        },

        startGamifiedLoader: () => {
          const steps = ["‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...", "‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶®‡ßá‡¶∞ ‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§ ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶®‡ßç‡¶ß‡¶æ‡¶®...", "‡¶π‡¶æ‡¶¶‡¶ø‡¶∏ ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...", "‡¶´‡¶ø‡¶ï‡¶π ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...", "‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá..."];
          const quotes = [
            "‚ùù ‡¶Ø‡ßá ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø ‡¶ú‡ßç‡¶û‡¶æ‡¶® ‡¶Ö‡¶®‡ßç‡¶¨‡ßá‡¶∑‡¶£‡ßá‡¶∞ ‡¶™‡¶•‡ßá ‡¶ö‡¶≤‡ßá, ‡¶Ü‡¶≤‡ßç‡¶≤‡¶æ‡¶π ‡¶§‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ú‡¶æ‡¶®‡ßç‡¶®‡¶æ‡¶§‡ßá‡¶∞ ‡¶™‡¶• ‡¶∏‡¶π‡¶ú ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶®‡•§ (‡¶Æ‡ßÅ‡¶∏‡¶≤‡¶ø‡¶Æ) ‚ùû",
            "‚ùù ‡¶á‡¶ï‡¶∞‡¶æ! ‡¶™‡ßú‡ßã ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶∞‡¶¨‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßá, ‡¶Ø‡¶ø‡¶®‡¶ø ‡¶∏‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§ (‡¶Ü‡¶≤-‡¶Ü‡¶≤‡¶æ‡¶ï:‡ßß) ‚ùû",
            "‚ùù ‡¶¶‡ßã‡¶≤‡¶®‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶¨‡¶∞ ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶ú‡ßç‡¶û‡¶æ‡¶® ‡¶Ö‡¶®‡ßç‡¶¨‡ßá‡¶∑‡¶£ ‡¶ï‡¶∞ ‚ùû",
            "‚ùù ‡¶ú‡ßç‡¶û‡¶æ‡¶®‡ßÄ ‡¶ì ‡¶Æ‡ßÇ‡¶∞‡ßç‡¶ñ ‡¶ï‡¶ø ‡¶∏‡¶Æ‡¶æ‡¶® ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá? ‚ùû",
            "‚ùù ‡¶∏‡¶¨‡¶ö‡ßá‡ßü‡ßá ‡¶â‡¶§‡ßç‡¶§‡¶Æ ‡¶¶‡¶æ‡¶® ‡¶π‡¶≤‡ßã ‡¶ú‡ßç‡¶û‡¶æ‡¶® ‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ‡•§ (‡¶á‡¶¨‡¶®‡ßá ‡¶Æ‡¶æ‡¶ú‡¶æ‡¶π) ‚ùû",
            "‚ùù ‡¶§‡ßã‡¶Æ‡¶∞‡¶æ ‡¶∏‡¶π‡¶ú ‡¶ï‡¶∞‡ßã, ‡¶ï‡¶†‡¶ø‡¶® ‡¶ï‡¶∞‡ßã ‡¶®‡¶æ‡•§ ‡¶∏‡ßÅ‡¶∏‡¶Ç‡¶¨‡¶æ‡¶¶ ‡¶¶‡¶æ‡¶ì, ‡¶¶‡ßÇ‡¶∞‡ßá ‡¶∏‡¶∞‡¶ø‡ßü‡ßá ‡¶¶‡¶ø‡¶ì ‡¶®‡¶æ‡•§ (‡¶¨‡ßÅ‡¶ñ‡¶æ‡¶∞‡ßÄ) ‚ùû",
            "‚ùù ‡¶Ü‡¶≤‡ßç‡¶≤‡¶æ‡¶π ‡¶Ø‡¶æ‡¶∞ ‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤ ‡¶ö‡¶æ‡¶®, ‡¶§‡¶æ‡¶ï‡ßá ‡¶¶‡ßç‡¶¨‡ßÄ‡¶®‡ßá‡¶∞ ‡¶ó‡¶≠‡ßÄ‡¶∞ ‡¶ú‡ßç‡¶û‡¶æ‡¶® ‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡ßá‡¶®‡•§ (‡¶¨‡ßÅ‡¶ñ‡¶æ‡¶∞‡ßÄ) ‚ùû"
          ];
          document.getElementById('loader').style.display = 'flex';
          let stepIndex = 0; let startTime = Date.now();
          document.getElementById('loaderText').innerText = steps[0];
          document.getElementById('loaderQuote').innerText = quotes[Math.floor(Math.random() * quotes.length)];

          loaderInterval = setInterval(() => {
            let elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
            document.getElementById('loaderSubText').innerText = elapsed + "s";
            if (stepIndex < steps.length - 1 && Math.random() > 0.6) {
              stepIndex++;
              document.getElementById('loaderText').innerText = steps[stepIndex];
              document.getElementById('loaderQuote').innerText = quotes[Math.floor(Math.random() * quotes.length)];
            }
          }, 700);
        },

        stopLoader: () => {
          clearInterval(loaderInterval);
          document.getElementById('loader').style.display = 'none';
        },

        displayResult: (q, ansObj, elapsed) => {
          document.getElementById('qContainer').style.display = 'none';
          document.querySelector('.cat-scroll-container').style.display = 'none';
          document.getElementById('resultArea').style.display = 'block';

          document.getElementById('resQuestionTitle').innerText = q;

          const magazineHtml = parseMagazine(ansObj.text);
          const enrichedHtml = ContentEnricher.parse(magazineHtml);
          const magaZineRenderedNode = document.getElementById('magazineContent');

          if (typeof IslamicModule !== 'undefined') {
            IslamicModule.AutoMatcher.processText(enrichedHtml, magaZineRenderedNode);
          } else {
            magaZineRenderedNode.innerHTML = enrichedHtml;
          }

          const sourceText = String(ansObj.source || 'Unknown');
          const sourceLower = sourceText.toLowerCase();
          const isOfflineSource = sourceLower.includes('offline') || sourceText.includes('‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®');
          const isAIResult = sourceLower.includes('gemini') || sourceLower.includes('openrouter') || sourceLower.includes('grok') || sourceLower.includes('ai');

          document.getElementById('aiStats').innerText = `‡¶Æ‡¶°‡ßá‡¶≤: ${sourceText} | ‡¶∏‡¶Æ‡¶Ø‡¶º: ${elapsed}s`;

          Logic.currentAnsSource = sourceText;
          Logic.currentAnsText = String(ansObj.text || '');
          Logic.currentAnsRefs = ReferenceTools.extractLines(ansObj.text, ansObj.ref);
          if (!Logic.historySyncing) Logic.pushViewState('result', { q });
          StorageEngine.setState('lastActivity', {
            type: 'result',
            q,
            askAI: !isOfflineSource,
            source: sourceText,
            ts: Date.now()
          });

          const expandBtn = document.getElementById('expandOfflineBtn');
          if (expandBtn) {
            expandBtn.style.display = isOfflineSource ? 'inline-flex' : 'none';
          }

          const verifyBtn = document.getElementById('verifyBtn');
          if (verifyBtn) {
            verifyBtn.style.display = 'inline-flex';
            verifyBtn.innerHTML = isAIResult
              ? '<span class="material-symbols-rounded">restart_alt</span> Re-Verify'
              : '<span class="material-symbols-rounded">verified</span> ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á';
          }

          // Smart Suggestions
          const suggestions = [
            `${q} ‡¶è‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶§‡¶ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶ï‡¶ø?`,
            `‡¶è ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶Ü‡¶∞‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶π‡¶æ‡¶¶‡¶ø‡¶∏ ‡¶Ü‡¶õ‡ßá?`,
            `‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡¶Æ‡¶æ‡¶ú‡ßá ‡¶è‡¶∞ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶ø‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶∞‡¶¨?`,
            `${q} ‡¶®‡¶ø‡ßü‡ßá ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶≠‡ßÅ‡¶≤ ‡¶ß‡¶æ‡¶∞‡¶£‡¶æ ‡¶ï‡¶ø?`,
            `${q} ‡¶è‡¶∞ ‡¶¶‡¶≤‡¶ø‡¶≤‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶® ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡ßã`,
            `${q} ‡¶π‡¶æ‡¶®‡¶æ‡¶´‡ßÄ ‡¶ì ‡¶∂‡¶æ‡¶´‡ßá‡ßü‡ßÄ ‡¶Æ‡¶§ ‡¶§‡ßÅ‡¶≤‡¶®‡¶æ`,
            `${q} ‡¶∂‡¶ø‡¶∂‡ßÅ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶π‡¶ú ‡¶≠‡¶æ‡¶∑‡¶æ‡ßü ‡¶¨‡ßÅ‡¶ù‡¶æ‡¶ì`,
            `${q} ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡¶ø‡¶™‡ßç‡¶§ ‡¶¨‡ßÅ‡¶≤‡ßá‡¶ü ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü`,
            `${q} ‡¶Ü‡¶∞‡¶¨‡¶ø ‡¶â‡¶¶‡ßç‡¶ß‡ßÉ‡¶§‡¶ø‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö‡¶æ‡¶∞‡¶£ ‡¶¶‡¶æ‡¶ì`,
            `${q} ‡¶¨‡¶æ‡¶∏‡ßç‡¶§‡¶¨ ‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£‡¶∏‡¶π ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ`,
            `${q} ‡¶¨‡¶ø‡¶∑‡ßü‡ßá ‡¶ï‡¶∞‡¶£‡ßÄ‡ßü ‡¶ì ‡¶¨‡¶∞‡ßç‡¶ú‡¶®‡ßÄ‡ßü`,
            `${q} ‡¶¨‡¶ø‡¶∑‡ßü‡ßá ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡¶ø‡¶™‡ßç‡¶§ ‡¶´‡¶ø‡¶ï‡¶π ‡¶®‡ßã‡¶ü`
          ];
          const suggestionSoft = [
            ['#ecfdf5', '#047857'],
            ['#eff6ff', '#1d4ed8'],
            ['#f0f9ff', '#0369a1'],
            ['#fdf2f8', '#be185d'],
            ['#fef3c7', '#b45309'],
            ['#f5f3ff', '#6d28d9'],
            ['#ecfeff', '#0e7490'],
            ['#fff7ed', '#c2410c'],
            ['#eef2ff', '#4338ca'],
            ['#f0fdf4', '#15803d'],
            ['#fff1f2', '#be123c']
          ];
          document.getElementById('suggestionChips').innerHTML = suggestions.map((s, i) => {
            const theme = suggestionSoft[i % suggestionSoft.length];
            return `<button class="suggestion-card" style="background:${theme[0]}; color:${theme[1]}; border-color:${theme[0]};" onclick="Logic.ask('${s.replace(/'/g, "\\'")}')">${s}</button>`;
          }).join('');

          window.scrollTo({ top: 0, behavior: 'smooth' });
        },

        showToast: (msg) => {
          const t = document.getElementById('toast');
          document.getElementById('toastMsg').innerText = msg;
          t.classList.add('show');
          setTimeout(() => t.classList.remove('show'), 3500);
        },

        toggleTheme: () => {
          const root = document.documentElement;
          const next = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
          root.setAttribute('data-theme', next);
          localStorage.setItem('theme', next);
          document.getElementById('themeIcon').innerText = next === 'dark' ? 'light_mode' : 'dark_mode';

          const sbTheme = document.getElementById('sbThemeIcon');
          if (sbTheme) sbTheme.innerText = next === 'dark' ? 'light_mode' : 'dark_mode';

          const metaColor = document.getElementById('meta-theme-color');
          if (metaColor) metaColor.content = next === 'dark' ? '#064e3b' : '#0b5e42';
        },

        openModal: (id) => {
          const m = document.getElementById(id);
          m.style.display = 'flex';
          setTimeout(() => m.classList.add('show'), 10); // Trigger animation
        },
        closeModal: (id) => {
          const m = document.getElementById(id);
          m.classList.remove('show');
          setTimeout(() => m.style.display = 'none', 300); // Wait for animation
        },

        renderHistory: (type) => {
          const data = StorageEngine.getArray(type);
          const html = data.length ? data.map(item => `
        <div style="background: var(--bg-main); padding: 16px; border-radius: 16px; margin-bottom: 12px; cursor:pointer; border: 1px solid var(--border-color); transition: all 0.2s;"
             onmouseover="this.style.borderColor='var(--accent-primary)'" onmouseout="this.style.borderColor='var(--border-color)'"
             onclick="Logic.ask('${item.q.replace(/'/g, "\\'")}'); UI.closeModal('historyModal');">
           <b style="font-size: 15px;">${item.q}</b>
        </div>
      `).join('') : '<p style="text-align:center; color:gray; padding: 20px;">‡¶ï‡ßã‡¶®‡ßã ‡¶§‡¶•‡ßç‡¶Ø ‡¶®‡ßá‡¶á</p>';
          document.getElementById('historyList').innerHTML = html;
        },

        changeFontSize: (step) => {
          const root = document.documentElement;
          let currentSize = parseFloat(getComputedStyle(root).getPropertyValue('--mag-font-size')) || 16;
          let newSize = currentSize + step;
          if (newSize < 12) newSize = 12;
          if (newSize > 26) newSize = 26;
          root.style.setProperty('--mag-font-size', newSize + 'px');
          UI.showToast(`‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú: ${newSize}px`);
        },

        toggleSidebar: () => {
          const sidebar = document.getElementById('sidebar');
          const overlay = document.getElementById('sidebarOverlay');
          if (sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
          } else {
            sidebar.classList.add('open');
            overlay.classList.add('show');
          }
        },

        registerServiceWorker: () => {
          if ('serviceWorker' in navigator) {
            const doRegister = () => {
              navigator.serviceWorker.register('sw.js').then(registration => {
                console.log('SW registered: ', registration.scope);
                if (window.SystemHub && typeof window.SystemHub.refreshStatus === 'function') {
                  window.SystemHub.refreshStatus();
                }
              }).catch(registrationError => {
                console.log('SW registration failed: ', registrationError);
              });
            };
            if (document.readyState === 'complete') doRegister();
            else window.addEventListener('load', doRegister, { once: true });
          }
        }
      };
    })();


    // ==========================================
    // 6. LOGIC & EVENT HANDLERS
    // ==========================================
    const Logic = {
      currentQ: '',
      currentAnsText: '',
      currentAnsSource: '',
      currentAnsRefs: [],
      currentOfflineSeed: '',
      currentView: 'home',
      historySyncing: false,
      isSpeaking: false,

      showHomeView: () => {
        document.getElementById('resultArea').style.display = 'none';
        document.getElementById('namazArea').style.display = 'none';
        document.querySelector('.cat-scroll-container').style.display = 'block';
        document.getElementById('qContainer').style.display = 'grid';
        if (Logic.isSpeaking) Logic.stopSpeak();
        NamazAudioEngine.stop();
        Logic.currentView = 'home';
      },

      pushViewState: (view, payload = {}) => {
        if (Logic.historySyncing) return;
        const current = history.state;
        // ‡¶Ø‡¶¶‡¶ø ‡¶è‡¶ï‡¶á view ‡¶è‡¶¨‡¶Ç ‡¶è‡¶ï‡¶á payload ‡¶π‡ßü ‡¶§‡¶¨‡ßá push ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá replace ‡¶ï‡¶∞‡ßÅ‡¶®
        if (current && current.view === view && JSON.stringify(current.payload) === JSON.stringify(payload)) {
          history.replaceState({ view, ...payload }, '', view === 'home' ? location.pathname : `#${view}`);
        } else {
          history.pushState({ view, ...payload }, '', view === 'home' ? location.pathname : `#${view}`);
        }
        Logic.currentView = view;
      },

      handlePopState: async (event) => {
        Logic.historySyncing = true;
        try {
          const state = event.state || { view: 'home' };
          if (state.view === 'namaz') {
            await NamazModule.showNamazView(true);
          } else if (state.view === 'result' && state.q) {
            await Logic.ask(state.q);
          } else {
            Logic.showHomeView();
          }
        } finally {
          Logic.historySyncing = false;
        }
      },

      init: async () => {
        try {
          UIEngine.registerServiceWorker(); // Setup PWA
          UIEngine.startGamifiedLoader();
          document.getElementById('loaderText').innerText = "‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";

          await DataModule.loadData();
          await StorageEngine.init();
          StorageEngine.loadSettings();
          ContentEnricher.injectStyles();

          if (typeof IslamicModule !== 'undefined') {
            await IslamicModule.init();
          }

          if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById('themeIcon').innerText = 'light_mode';
            const sbTheme = document.getElementById('sbThemeIcon');
            if (sbTheme) sbTheme.innerText = 'light_mode';
            const metaColor = document.getElementById('meta-theme-color');
            if (metaColor) metaColor.content = '#064e3b';
          }

          checkOfflineStatus();
          window.addEventListener('online', () => {
            checkOfflineStatus();
            if (window.SystemHub) window.SystemHub.refreshStatus();
          });
          window.addEventListener('offline', () => {
            checkOfflineStatus();
            if (window.SystemHub) window.SystemHub.refreshStatus();
          });

          UIEngine.initScroll();
          UIEngine.renderCategories('all');
          UIEngine.renderQuestions('all');
          if (window.SystemHub) await window.SystemHub.init();

          history.replaceState({ view: 'home' }, '', location.pathname);
          window.addEventListener('popstate', Logic.handlePopState);

          document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') Logic.handleSearch();
          });
        } catch (err) {
          console.error("Init Error:", err);
          UIEngine.showToast("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
        } finally {
          UIEngine.stopLoader();
        }
      },

      filterCat: (id) => {
        UIEngine.renderCategories(id);
        UIEngine.renderQuestions(id);
        document.getElementById('resultArea').style.display = 'none';
        document.querySelector('.cat-scroll-container').style.display = 'block';
        if (Logic.isSpeaking) Logic.stopSpeak();
      },

      handleSearch: () => {
        const q = document.getElementById('searchInput').value.trim();
        if (q) Logic.ask(q);
      },

      openQuranPage: async () => {
        await StorageEngine.setState('lastActivity', { type: 'quran_reader', ts: Date.now() });
        window.location.href = 'quran.html';
      },

      goBack: () => {
        const st = history.state && history.state.view;
        if (st && st !== 'home') history.back();
        else Logic.showHomeView();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      },

      ask: async (q) => {
        Logic.currentQ = q;
        document.getElementById('searchInput').value = q;
        if (Logic.isSpeaking) Logic.stopSpeak();

        const aiToggle = document.getElementById('aiToggle');
        const askAI = aiToggle ? aiToggle.checked : true;

        if (!askAI && !VisionProcessor.getImage()) {
          const offlineAns = DataModule.questionMap ? DataModule.questionMap[q] : null;
          if (offlineAns && offlineAns.a) {
            let formattedOffline = offlineAns.a + "\n\n";
            if (offlineAns.ref) {
              formattedOffline += `**‡¶§‡¶•‡ßç‡¶Ø‡¶∏‡ßÇ‡¶§‡ßç‡¶∞:** ${offlineAns.ref}\n\n`;
            }

            Logic.currentOfflineSeed = offlineAns.a;
            UIEngine.displayResult(q, { text: formattedOffline, source: '‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® (ans.json)' }, '0.0');

            StorageEngine.pushArray('history', { q });
            return;
          }
        }

        if (!VisionProcessor.getImage()) {
          const cached = await StorageEngine.getCache(q);
          if (cached) {
            Logic.currentOfflineSeed = '';
            UIEngine.displayResult(q, { text: cached, source: 'Cache' }, '0.1');
            StorageEngine.pushArray('history', { q });
            return;
          }
        }

        UIEngine.startGamifiedLoader();
        const start = Date.now();
        try {
          const ansObj = await AIEngine.run(q);
          const elapsed = ((Date.now() - start) / 1000).toFixed(1);

          Logic.currentOfflineSeed = '';
          if (!VisionProcessor.getImage()) await StorageEngine.setCache(q, ansObj.text);

          UIEngine.displayResult(q, ansObj, elapsed);
          StorageEngine.pushArray('history', { q });
          VisionProcessor.clearImage();

        } catch (err) {
          if (err.name !== 'AbortError') UIEngine.showToast(err.message);
        } finally {
          UIEngine.stopLoader();
        }
      },

      expandOfflineAnswer: async () => {
        if (!Logic.currentQ) {
          UIEngine.showToast('‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
          return;
        }
        const base = String(Logic.currentOfflineSeed || Logic.currentAnsText || '').replace(/<[^>]*>/g, ' ').trim();
        if (!base) {
          UIEngine.showToast('‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§');
          return;
        }

        const aiToggle = document.getElementById('aiToggle');
        if (aiToggle) aiToggle.checked = true;

        UIEngine.startGamifiedLoader();
        document.getElementById('loaderText').innerText = "‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
        const start = Date.now();
        try {
          const qForAI = `${Logic.currentQ}

‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡¶ø‡¶™‡ßç‡¶§ ‡¶â‡¶§‡ßç‡¶§‡¶∞:
${base}

‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶ü‡¶ø ‡¶Ü‡¶∞‡¶ì ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶ï‡¶∞‡ßã‡•§
‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á: ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶ì ‡¶π‡¶æ‡¶¶‡¶ø‡¶∏‡ßá‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏‡ßá ‡¶Ü‡¶∞‡¶¨‡¶ø, ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶â‡¶ö‡ßç‡¶ö‡¶æ‡¶∞‡¶£, ‡¶Ö‡¶∞‡ßç‡¶•, ‡¶π‡¶æ‡¶¶‡¶ø‡¶∏ ‡¶¨‡¶á+‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶æ‡¶ì‡•§`;

          const ansObj = await AIEngine.run(qForAI);
          const elapsed = ((Date.now() - start) / 1000).toFixed(1);
          UIEngine.displayResult(Logic.currentQ, { text: ansObj.text, source: `${ansObj.source} (Offline Expand)` }, elapsed);
          StorageEngine.pushArray('history', { q: Logic.currentQ });
        } catch (e) {
          UIEngine.showToast('AI expand ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
        } finally {
          UIEngine.stopLoader();
        }
      },

      buildShareMetaBlock: () => {
        const resultArea = document.getElementById('resultArea');
        if (!resultArea) return null;

        const old = document.getElementById('shareRefMeta');
        if (old) old.remove();

        const refs = (Logic.currentAnsRefs || []).slice(0, 8);
        const refHtml = refs.length
          ? refs.map((r, i) => `<div style="margin-top:4px;">${i + 1}. ${String(r)}</div>`).join('')
          : '<div style="margin-top:4px;">‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶≤‡ßç‡¶≤‡ßá‡¶ñ‡¶ø‡¶§</div>';

        const meta = document.createElement('div');
        meta.id = 'shareRefMeta';
        meta.style.marginTop = '18px';
        meta.style.padding = '12px';
        meta.style.border = '1px dashed var(--border-color)';
        meta.style.borderRadius = '12px';
        meta.style.background = 'var(--bg-main)';
        meta.style.fontSize = '12px';
        meta.style.color = 'var(--text-secondary)';
        meta.innerHTML = `<b>Exact Reference Snapshot</b><div style="margin-top:6px;">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®: ${Logic.currentQ}</div><div style="margin-top:4px;">‡¶∏‡ßã‡¶∞‡ßç‡¶∏: ${Logic.currentAnsSource || '-'}</div>${refHtml}`;
        resultArea.appendChild(meta);
        return meta;
      },

      getShareReferenceText: () => {
        const refs = (Logic.currentAnsRefs || []).slice(0, 8);
        if (!refs.length) return '‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏: ‡¶Ö‡¶®‡ßÅ‡¶≤‡ßç‡¶≤‡ßá‡¶ñ‡¶ø‡¶§';
        return `‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏:\n${refs.map((r, i) => `${i + 1}. ${r}`).join('\n')}`;
      },

      copyAns: () => {
        navigator.clipboard.writeText(Logic.currentAnsText.replace(/<[^>]*>/g, ''));
        UIEngine.showToast('‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!');
      },

      changeFontSize: (step) => {
        const contentArea = document.getElementById('magazineContent');
        let currentSize = parseInt(window.getComputedStyle(contentArea).fontSize);
        if (isNaN(currentSize)) currentSize = 16;
        let newSize = currentSize + (step * 2);

        // Limits: 12px to 28px
        if (newSize >= 12 && newSize <= 28) {
          contentArea.style.fontSize = newSize + 'px';
          UIEngine.showToast(`‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú ${newSize}px ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá`);
        } else {
          UIEngine.showToast('‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü ‡¶™‡ßå‡¶Å‡¶õ‡ßá‡¶õ‡ßá');
        }
      },

      shareAns: async () => {
        UIEngine.showToast('‡¶õ‡¶¨‡¶ø ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá, ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...');
        try {
          const resultArea = document.getElementById('resultArea');
          // temporarily hide non-essential elements for clean screenshot
          const actionBar = resultArea.querySelector('.action-bar');
          const chips = document.getElementById('suggestionChips');
          const shareMeta = Logic.buildShareMetaBlock();
          const referenceText = Logic.getShareReferenceText();

          if (actionBar) actionBar.style.display = 'none';
          if (chips) chips.parentNode.style.display = 'none';

          const canvas = await html2canvas(resultArea, {
            scale: 2,
            backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-surface'),
            useCORS: true
          });

          if (actionBar) actionBar.style.display = 'flex';
          if (chips) chips.parentNode.style.display = 'block';
          if (shareMeta) shareMeta.remove();

          canvas.toBlob(async (blob) => {
            const file = new File([blob], 'islamic_knowledge.png', { type: 'image/png' });
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
              await navigator.share({
                title: Logic.currentQ,
                text: `‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®: ${Logic.currentQ}\n‡¶∏‡ßã‡¶∞‡ßç‡¶∏: ${Logic.currentAnsSource || '-'}\n\n${referenceText}\n\n(‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶ú‡ßç‡¶û‡¶æ‡¶®Hub ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶•‡ßá‡¶ï‡ßá)`,
                files: [file]
              });
            } else {
              // Fallback to text copy if image share not supported
              navigator.clipboard.writeText(`‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®: ${Logic.currentQ}\n\n${Logic.currentAnsText.replace(/<[^>]*>/g, '')}\n\n${referenceText}`);
              UIEngine.showToast('‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏‡ßá ‡¶õ‡¶¨‡¶ø ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü‡ßá‡¶° ‡¶®‡ßü, ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!');
            }
          }, 'image/png');
        } catch (e) {
          console.error("Share Image Failed", e);
          const danglingMeta = document.getElementById('shareRefMeta');
          if (danglingMeta) danglingMeta.remove();
          const resultArea = document.getElementById('resultArea');
          const actionBar = resultArea ? resultArea.querySelector('.action-bar') : null;
          const chips = document.getElementById('suggestionChips');
          if (actionBar) actionBar.style.display = 'flex';
          if (chips && chips.parentNode) chips.parentNode.style.display = 'block';
          Logic.copyAns();
          UIEngine.showToast('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá, ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§');
        }
      },

      downloadAns: async () => {
        UIEngine.showToast('‡¶õ‡¶¨‡¶ø ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
        try {
          const resultArea = document.getElementById('resultArea');
          const actionBar = resultArea.querySelector('.action-bar');
          const chips = document.getElementById('suggestionChips');
          const shareMeta = Logic.buildShareMetaBlock();

          if (actionBar) actionBar.style.display = 'none';
          if (chips) chips.parentNode.style.display = 'none';

          const canvas = await html2canvas(resultArea, {
            scale: 2,
            backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-surface'),
            useCORS: true
          });

          if (actionBar) actionBar.style.display = 'flex';
          if (chips) chips.parentNode.style.display = 'block';
          if (shareMeta) shareMeta.remove();

          const url = canvas.toDataURL('image/png');
          const a = document.createElement('a');
          a.href = url;
          a.download = "Islamic_Knowledge_" + Date.now() + ".png";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);

          UIEngine.showToast('‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá!');
        } catch (e) {
          console.error("Download Failed", e);
          const danglingMeta = document.getElementById('shareRefMeta');
          if (danglingMeta) danglingMeta.remove();
          const resultArea = document.getElementById('resultArea');
          const actionBar = resultArea ? resultArea.querySelector('.action-bar') : null;
          const chips = document.getElementById('suggestionChips');
          if (actionBar) actionBar.style.display = 'flex';
          if (chips && chips.parentNode) chips.parentNode.style.display = 'block';
          UIEngine.showToast('‡¶´‡¶ü‡ßã ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
        }
      },

      // Robust Voice Output (TTS) with Fallback
      speakAns: () => {
        if (Logic.isSpeaking) { Logic.stopSpeak(); return; }

        const text = Logic.currentAnsText.replace(/<[^>]*>/g, '').replace(/[\u0600-\u06FF]/g, ' ').substring(0, 1500);

        if (typeof responsiveVoice !== 'undefined') {
          Logic.isSpeaking = true;
          document.getElementById('speakBtn').innerHTML = '<span class="material-symbols-rounded">stop_circle</span> ‡¶•‡¶æ‡¶Æ‡ßÅ‡¶®';
          responsiveVoice.speak(text, "Bengali Female", {
            rate: 0.9,
            onend: Logic.stopSpeak
          });
          UIEngine.showToast('‡¶™‡ßú‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
        } else if ('speechSynthesis' in window) {
          Logic.isSpeaking = true;
          document.getElementById('speakBtn').innerHTML = '<span class="material-symbols-rounded">stop_circle</span> ‡¶•‡¶æ‡¶Æ‡ßÅ‡¶®';
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = 'bn-BD';
          utterance.rate = 0.9;
          utterance.onend = Logic.stopSpeak;
          window.speechSynthesis.speak(utterance);
          UIEngine.showToast('‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏ ‡¶≠‡ßü‡ßá‡¶∏ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶π‡ßü‡ßá‡¶õ‡ßá...');
        } else {
          UIEngine.showToast('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ Text-to-Speech ‡¶∏‡¶Æ‡¶∞‡ßç‡¶•‡¶® ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ‡•§');
        }
      },

      stopSpeak: () => {
        if (typeof responsiveVoice !== 'undefined') responsiveVoice.cancel();
        if ('speechSynthesis' in window) window.speechSynthesis.cancel();
        Logic.isSpeaking = false;
        const btn = document.getElementById('speakBtn');
        if (btn) btn.innerHTML = '<span class="material-symbols-rounded">volume_up</span> ‡¶∂‡ßÅ‡¶®‡ßÅ‡¶®';
      },

      saveBookmark: () => {
        const success = StorageEngine.pushArray('bookmark', { q: Logic.currentQ });
        if (success) UIEngine.showToast('‡¶¨‡ßÅ‡¶ï‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá');
        else UIEngine.showToast('‡¶è‡¶ü‡¶ø ‡¶Ü‡¶ó‡ßá‡¶á ‡¶¨‡ßÅ‡¶ï‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá');
      },

      verifyAns: () => {
        const escapeHtml = (text) => {
          return String(text || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;')
            .replace(/`/g, '&#96;');
        };

        const local = DataModule.questionMap ? DataModule.questionMap[Logic.currentQ] : null;
        const old = document.getElementById('offlineVerifyCard');
        if (old) old.remove();

        const hasLocal = local && local.a;
        const hadithRefs = ReferenceTools.findHadithRefs(Logic.currentAnsText || '');
        const quranRefs = ReferenceTools.findQuranRefs(Logic.currentAnsText || '');
        const localRefText = String((local && local.ref) || '');
        const hadithMatchedInLocal = hadithRefs.filter(item => localRefText.includes(item.number)).length;

        const detectedRefHtml = `
          ${(quranRefs.length || hadithRefs.length) ? `
            <div style="margin-top:10px; padding:10px; border-radius:10px; background:var(--bg-main); border:1px solid var(--border-color);">
              <div style="font-size:13px; font-weight:700; margin-bottom:6px;">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶â‡¶§‡ßç‡¶§‡¶∞‡ßá‡¶∞ detected references</div>
              ${quranRefs.length ? `<div style="font-size:12px; margin-bottom:6px;"><b>‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶®:</b> ${quranRefs.map(item => `‡¶∏‡ßÇ‡¶∞‡¶æ ${escapeHtml(item.surah)}:${escapeHtml(item.ayah)}`).join(' | ')}</div>` : ''}
              ${hadithRefs.length ? `<div style="font-size:12px; margin-bottom:4px;"><b>‡¶π‡¶æ‡¶¶‡¶ø‡¶∏:</b></div>
                <div style="display:flex; flex-wrap:wrap; gap:6px;">
                  ${hadithRefs.map(item => {
                    const url = HadithVerifier.getUrl(item.book, item.number);
                    return `<a href="${escapeHtml(url)}" target="_blank" rel="noopener" class="btn-mini" style="text-decoration:none; padding:4px 10px;">${escapeHtml(item.book)} ${escapeHtml(item.number)}</a>`;
                  }).join('')}
                </div>
                ${local && local.ref ? `<div style="font-size:11px; color:var(--text-secondary); margin-top:6px;">‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö: ${hadithMatchedInLocal}/${hadithRefs.length}</div>` : ''}` : ''}
            </div>` : ''
        }`;

        let html = '';

        if (hasLocal) {
          html = `
            <div id="offlineVerifyCard" class="islamic-embed-card" style="border-left-color:#0ea5e9;">
              <div class="embed-header">
                <span class="material-symbols-rounded" style="color:#0ea5e9;">policy</span>
                <span>‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á</span>
                <span style="margin-left:auto; font-size:12px; background:#e0f2fe; color:#0369a1; padding:2px 8px; border-radius:12px;">‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá</span>
              </div>
              <div class="embed-body">
                <div style="font-size:14px; margin-bottom:8px;"><b>‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶â‡¶§‡ßç‡¶§‡¶∞:</b> ${escapeHtml(local.a)}</div>
                ${local.ref ? `<div style="font-size:13px; color:var(--text-secondary);"><b>‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏:</b> ${escapeHtml(local.ref)}</div>` : ''}
                ${detectedRefHtml}
              </div>
            </div>`;
          UIEngine.showToast("‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá‡•§");
        } else {
          html = `
            <div id="offlineVerifyCard" class="islamic-embed-card" style="border-left-color:#f59e0b;">
              <div class="embed-header">
                <span class="material-symbols-rounded" style="color:#f59e0b;">warning</span>
                <span>‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á</span>
                <span style="margin-left:auto; font-size:12px; background:#fef3c7; color:#b45309; padding:2px 8px; border-radius:12px;">‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö ‡¶®‡ßá‡¶á</span>
              </div>
              <div class="embed-body">
                <div style="font-size:14px;">‡¶è‡¶á ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßá AI verify ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</div>
                ${detectedRefHtml}
              </div>
            </div>`;
          UIEngine.showToast("‡¶è‡¶á ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§");
        }

        document.getElementById('magazineContent').insertAdjacentHTML('afterbegin', html);
      },

      verify: () => {
        Logic.verifyAns();
      }
    };

    // Application Bootstrap
    window.onload = Logic.init;
    window.UI = UIEngine;
    window.VisionProcessor = VisionProcessor;
    window.AIEngine = AIEngine;
    window.Logic = Logic;
    window.StorageEngine = StorageEngine;
    window.AudioManager = AudioManager;
    window.ContentEnricher = ContentEnricher;
    window.SystemHub = SystemHub;
    window.HadithVerifier = HadithVerifier;
    window.ArabicAssist = ArabicAssist;
    window.ReferenceTools = ReferenceTools;

  </script>
</body>

</html>